<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TokenOriginate | Credit Risk Scoring</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<style>
/* ── Root theme variables ── */
:root {
  --bg:          #0a0a0f;
  --surface:     #111118;
  --surface2:    #18181f;
  --border:      #1f1f2e;
  --accent:      #c9a84c;
  --accent2:     #e8c97a;
  --text:        #f0f0f5;
  --text-muted:  #55556a;
  --verde:       #4caf7d;
  --amarillo:    #c9a84c;
  --naranja:     #e07b39;
  --rojo:        #e05252;
}

/* ── Reset & base ── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', 'Segoe UI', Arial, sans-serif; background: var(--bg); color: var(--text);
       display: flex; height: 100vh; overflow: hidden; }

/* ── Sidebar ── */
#sidebar {
  width: 300px; min-width: 300px; background: var(--surface);
  height: 100vh; overflow-y: auto; padding: 1.4rem 1.2rem;
  display: flex; flex-direction: column; gap: 0; flex-shrink: 0;
  border-right: 1px solid var(--border);
}
#sidebar::-webkit-scrollbar { width: 4px; }
#sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

.sb-logo { color: var(--text); font-size: 1.1rem; font-weight: 800; margin-bottom: .15rem; }
.sb-sub  { color: var(--text-muted); font-size: .72rem; font-weight: 600;
           text-transform: uppercase; letter-spacing: .8px; margin-bottom: 1rem; }
.sb-sep  { border: none; border-top: 1px solid var(--border); margin: .9rem 0; }
.sb-sec  { font-size: .65rem; font-weight: 700; text-transform: uppercase;
           letter-spacing: .8px; color: var(--text-muted); margin-bottom: .6rem;
           padding-bottom: .3rem; border-bottom: 1px solid var(--border); }

.field   { margin-bottom: .7rem; }
.field label { display: block; font-size: .68rem; font-weight: 700; color: var(--text-muted);
               text-transform: uppercase; letter-spacing: .08em; margin-bottom: .3rem; }
.field input, .field select {
  width: 100%; background: var(--surface2); color: var(--text); border: 1px solid var(--border);
  border-radius: 6px; padding: .35rem .5rem; font-size: .85rem; outline: none;
}
.field input:focus, .field select:focus { border-color: var(--accent); }
.field select option { background: var(--surface2); color: var(--text); }

/* Example buttons */
.ex-btns { display: flex; gap: .4rem; margin-bottom: .5rem; flex-wrap: wrap; }
.ex-btn  { flex: 1; min-width: 60px; background: var(--surface2); color: var(--text-muted);
           border: 1px solid var(--border); border-radius: 6px;
           padding: .45rem .3rem; font-size: .75rem; font-weight: 700; cursor: pointer;
           transition: all .15s; }
.ex-btn:hover { border-color: var(--accent); color: var(--accent); }

/* Action buttons */
.action-btn { width: 100%; margin-top: .5rem; background: var(--accent);
              color: #0a0a0f; border: none; border-radius: 6px;
              padding: .55rem; font-size: .85rem; font-weight: 700; cursor: pointer;
              transition: background .15s; }
.action-btn:hover { background: var(--accent2); }
.reset-btn  { width: 100%; margin-top: .4rem; background: transparent;
              color: var(--text-muted); border: 1px solid var(--border); border-radius: 6px;
              padding: .45rem; font-size: .82rem; font-weight: 600; cursor: pointer;
              transition: all .15s; }
.reset-btn:hover { border-color: var(--accent); color: var(--accent); }

/* ── Main ── */
#main { flex: 1; overflow-y: auto; padding: 1.5rem 1.8rem; }
#main::-webkit-scrollbar { width: 6px; }
#main::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

.main-header { display: flex; justify-content: space-between; align-items: flex-start;
               margin-bottom: 1.5rem; }
.main-header h1 { font-size: 1.55rem; font-weight: 800; color: var(--text); }
.main-header p  { font-size: .82rem; color: var(--text-muted); margin-top: .2rem; }

/* ── Section tabs ── */
.tabs { display: flex; gap: .5rem; margin-bottom: 1.4rem; flex-wrap: wrap; }
.tab  { padding: .45rem 1.1rem; border-radius: 20px; font-size: .8rem; font-weight: 700;
        cursor: pointer; border: 2px solid transparent; transition: all .2s; }
.tab.active  { background: var(--accent); color: #0a0a0f; border-color: var(--accent); }
.tab.inactive{ background: var(--surface); color: var(--text-muted); border-color: var(--border); }
.tab.inactive:hover { border-color: var(--accent); color: var(--accent); }

.section { display: none; }
.section.active { display: block; }

/* ── Gating Banner ── */
.gating-banner {
  background: linear-gradient(135deg, #1a0505, #2d0909);
  border: 1px solid rgba(224,82,82,.25);
  border-radius: 12px; padding: 1rem 1.4rem;
  margin-bottom: 1.5rem; display: none;
  animation: fadeIn .4s ease;
}
.gating-banner.visible { display: block; }
.gating-banner .g-title { font-size: .75rem; font-weight: 800; text-transform: uppercase;
                           letter-spacing: 1px; color: var(--rojo); margin-bottom: .4rem; }
.gating-banner .g-text  { font-size: .95rem; font-weight: 700; color: var(--text); line-height: 1.5; }

/* ── KPI strip ── */
.kpi-strip { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px,1fr));
             gap: 1rem; margin-bottom: 1.4rem; }
.kpi { background: var(--surface); border-radius: 12px; padding: 1rem 1.1rem;
       border: 1px solid var(--border); }
.kpi .k-label { font-size: .68rem; font-weight: 700; text-transform: uppercase;
                letter-spacing: .6px; color: var(--text-muted); margin-bottom: .3rem; }
.kpi .k-value { font-size: 1.55rem; font-weight: 800; color: var(--text); line-height: 1; }
.kpi .k-sub   { font-size: .72rem; color: var(--text-muted); margin-top: .2rem; }

/* ── Score row ── */
.score-row { display: grid; grid-template-columns: 260px 1fr; gap: 1.2rem;
             margin-bottom: 1.4rem; }
@media (max-width: 900px) { .score-row { grid-template-columns: 1fr; } }

/* ── Charts grid ── */
.chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem;
              margin-bottom: 1.4rem; }
@media (max-width: 820px) { .chart-grid { grid-template-columns: 1fr; } }

.card { background: var(--surface); border-radius: 14px; padding: 1.2rem 1.4rem;
        border: 1px solid var(--border); }
.card-title { font-size: .78rem; font-weight: 700; text-transform: uppercase;
              letter-spacing: .6px; color: var(--text-muted); margin-bottom: 1rem; }

/* ── Ratio tiles ── */
.ratio-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr));
              gap: .8rem; margin-bottom: 1.4rem; }
.ratio-tile { background: var(--surface); border-radius: 10px; padding: .85rem 1rem;
              border: 1px solid var(--border); border-left: 3px solid var(--border);
              transition: transform .15s; }
.ratio-tile:hover { transform: translateY(-2px); }
.ratio-tile.verde   { border-left-color: var(--verde); }
.ratio-tile.amarillo{ border-left-color: var(--amarillo); }
.ratio-tile.naranja { border-left-color: var(--naranja); }
.ratio-tile.rojo    { border-left-color: var(--rojo); }
.rt-label { font-size: .65rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: .5px; color: var(--text-muted); }
.rt-value { font-size: 1.4rem; font-weight: 800; color: var(--text); margin: .2rem 0; }
.rt-sub   { font-size: .7rem; color: var(--text-muted); }
.rt-score { font-size: .72rem; font-weight: 700; margin-top: .35rem;
            padding: .15rem .45rem; border-radius: 20px; display: inline-block; }
.verde    .rt-score { background: rgba(76,175,125,.15); color: var(--verde); }
.amarillo .rt-score { background: rgba(201,168,76,.15); color: var(--amarillo); }
.naranja  .rt-score { background: rgba(224,123,57,.15); color: var(--naranja); }
.rojo     .rt-score { background: rgba(224,82,82,.15); color: var(--rojo); }

/* LTV indicator in sidebar */
.ltv-indicator { border-radius: 6px; padding: .4rem .6rem; margin-top: .3rem;
                 font-size: .75rem; font-weight: 700; display: none; }
.ltv-ok   { background: rgba(76,175,125,.15); color: var(--verde); display: block; }
.ltv-warn { background: rgba(201,168,76,.15); color: var(--amarillo); display: block; }
.ltv-bad  { background: rgba(224,82,82,.15); color: var(--rojo); display: block; }
.gating-badge { font-size: .6rem; font-weight: 800; text-transform: uppercase;
                background: rgba(201,168,76,.2); color: var(--accent); padding: .1rem .35rem;
                border-radius: 4px; margin-left: .3rem; vertical-align: middle; }

/* ── Recommendation banner ── */
.rec-banner { border-radius: 14px; padding: 1.3rem 1.6rem; margin-bottom: 1.4rem;
              display: flex; align-items: flex-start; gap: 1.2rem; }
.rec-banner.verde    { background: rgba(76,175,125,.07); border: 1px solid rgba(76,175,125,.2); border-left: 5px solid var(--verde); }
.rec-banner.amarillo { background: rgba(201,168,76,.07); border: 1px solid rgba(201,168,76,.2); border-left: 5px solid var(--amarillo); }
.rec-banner.rojo     { background: rgba(224,82,82,.07); border: 1px solid rgba(224,82,82,.2); border-left: 5px solid var(--rojo); }
.rec-icon { font-size: 2.5rem; line-height: 1; }
.rec-body .rec-label { font-size: .72rem; font-weight: 700; text-transform: uppercase;
                        letter-spacing: .7px; color: var(--text-muted); margin-bottom: .25rem; }
.rec-body .rec-decision { font-size: 1.5rem; font-weight: 900; margin-bottom: .3rem; }
.verde .rec-decision    { color: var(--verde); }
.amarillo .rec-decision { color: var(--amarillo); }
.rojo .rec-decision     { color: var(--rojo); }
.rec-body .rec-text { font-size: .9rem; color: var(--text); line-height: 1.6; }

/* ── Risk factors ── */
.risk-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr));
             gap: 1rem; margin-bottom: 1.4rem; }
.risk-card { background: var(--surface); border-radius: 12px; padding: 1rem 1.2rem;
             border: 1px solid var(--border); border-left: 4px solid var(--rojo); }
.risk-card .r-rank  { font-size: .65rem; font-weight: 800; text-transform: uppercase;
                       color: var(--rojo); letter-spacing: .5px; }
.risk-card .r-name  { font-size: .92rem; font-weight: 700; color: var(--text); margin: .2rem 0; }
.risk-card .r-value { font-size: .8rem; color: var(--text-muted); }
.risk-card .r-impact{ font-size: .78rem; font-weight: 700; color: var(--rojo); margin-top: .3rem; }

/* ── Nueva Deuda section ── */
.nueva-deuda-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem; margin-bottom: 1.4rem; }
@media (max-width: 820px) { .nueva-deuda-grid { grid-template-columns: 1fr; } }

.nd-result { background: var(--surface); border-radius: 14px; padding: 1.2rem 1.4rem;
             border: 1px solid var(--border); }
.nd-row { display: flex; justify-content: space-between; align-items: center;
          padding: .5rem 0; border-bottom: 1px solid var(--border); }
.nd-row:last-child { border-bottom: none; }
.nd-lbl { font-size: .8rem; color: var(--text-muted); }
.nd-val { font-size: .9rem; font-weight: 700; color: var(--text); }
.nd-status { padding: .2rem .7rem; border-radius: 20px; font-size: .78rem; font-weight: 700; }
.nd-ok   { background: rgba(76,175,125,.15); color: var(--verde); }
.nd-warn { background: rgba(201,168,76,.15); color: var(--amarillo); }
.nd-bad  { background: rgba(224,82,82,.15); color: var(--rojo); }

/* ── Sector comparables ── */
.sect-table { width: 100%; border-collapse: collapse; font-size: .82rem; }
.sect-table th { background: var(--surface2); font-size: .68rem; font-weight: 700;
                 text-transform: uppercase; letter-spacing: .5px; color: var(--accent);
                 padding: .6rem .8rem; text-align: left; }
.sect-table td { padding: .55rem .8rem; border-bottom: 1px solid var(--border); color: var(--text); }
.sect-table tr:last-child td { border-bottom: none; }
.sect-table tr:nth-child(even) td { background: rgba(255,255,255,.015); }
.sect-table tr.company-row td { background: rgba(201,168,76,.07); font-weight: 700; color: var(--accent); }
.pos-p25  { color: var(--verde); font-weight: 700; }
.pos-med  { color: var(--amarillo); font-weight: 700; }
.pos-p75  { color: var(--rojo); font-weight: 700; }
.pos-good { color: var(--verde); }
.pos-mid  { color: var(--amarillo); }
.pos-bad  { color: var(--rojo); }

/* ── Covenants ── */
.cov-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
            gap: .9rem; margin-bottom: 1.2rem; }
.cov-card { background: var(--surface); border-radius: 12px; padding: 1rem 1.2rem;
            border: 1px solid var(--border); border-left: 4px solid var(--accent); }
.cov-name  { font-size: .68rem; font-weight: 700; text-transform: uppercase;
             letter-spacing: .5px; color: var(--text-muted); margin-bottom: .4rem; }
.cov-value { font-size: 1.25rem; font-weight: 800; color: var(--text); }
.cov-desc  { font-size: .75rem; color: var(--text-muted); margin-top: .3rem; }

.pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
                gap: .9rem; margin-bottom: 1rem; }
.pricing-card { background: var(--surface2); border-radius: 10px; padding: .8rem 1rem;
                border: 1px solid var(--border); text-align: center; }
.pricing-card.active-price { background: rgba(201,168,76,.08); border-color: var(--accent); }
.pc-tranche { font-size: .68rem; font-weight: 700; text-transform: uppercase;
              letter-spacing: .5px; color: var(--text-muted); margin-bottom: .3rem; }
.pc-spread  { font-size: 1.2rem; font-weight: 800; color: var(--accent); }
.pc-note    { font-size: .72rem; color: var(--text-muted); margin-top: .2rem; }

/* ── Detail table ── */
.det-table { width: 100%; border-collapse: collapse; font-size: .83rem; }
.det-table th { background: var(--surface2); font-size: .68rem; font-weight: 700;
                text-transform: uppercase; letter-spacing: .5px; color: var(--accent);
                padding: .65rem .9rem; text-align: left; }
.det-table td { padding: .6rem .9rem; border-bottom: 1px solid var(--border); color: var(--text); }
.det-table tr:last-child td { border-bottom: none; }
.det-table tr:nth-child(even) td { background: rgba(255,255,255,.015); }
.badge-v { background: rgba(76,175,125,.15); color: var(--verde); padding: .15rem .5rem;
           border-radius: 20px; font-size: .72rem; font-weight: 700; }
.badge-a { background: rgba(201,168,76,.15); color: var(--amarillo); padding: .15rem .5rem;
           border-radius: 20px; font-size: .72rem; font-weight: 700; }
.badge-r { background: rgba(224,82,82,.15); color: var(--rojo); padding: .15rem .5rem;
           border-radius: 20px; font-size: .72rem; font-weight: 700; }
.badge-n { background: rgba(224,123,57,.15); color: var(--naranja); padding: .15rem .5rem;
           border-radius: 20px; font-size: .72rem; font-weight: 700; }
.badge-g { background: rgba(201,168,76,.2); color: var(--accent); padding: .15rem .5rem;
           border-radius: 20px; font-size: .72rem; font-weight: 700; }

/* ── Colateral inventory table ── */
.col-table { width:100%; border-collapse:collapse; font-size:.82rem; }
.col-table th { background:var(--surface2); font-size:.67rem; font-weight:700; text-transform:uppercase;
                letter-spacing:.5px; color:var(--accent); padding:.55rem .7rem; text-align:left; white-space:nowrap; }
.col-table td { padding:.42rem .7rem; border-bottom:1px solid var(--border); vertical-align:middle; color:var(--text); }
.col-table tfoot td { padding:.6rem .7rem; font-weight:800; color:var(--text); }
.col-inp { background:var(--surface2); border:1px solid var(--border); border-radius:6px;
           padding:.28rem .4rem; font-size:.8rem; font-family:inherit; color:var(--text); }
.col-inp:focus { border-color:var(--accent); outline:none; }
.col-inp-desc { width:140px; }
.col-inp-num  { width:70px; text-align:right; }
.col-sel { width:155px; }
.col-haircut { text-align:center; font-weight:700; color:var(--naranja); }
.col-neto    { text-align:right; font-weight:800; color:var(--text); }
.col-del-btn { background:none; border:none; color:var(--rojo); font-size:1.1rem;
               cursor:pointer; padding:.1rem .3rem; line-height:1; }
.col-del-btn:hover { color:#ff7070; }

/* ── Recovery metric cards ── */
.rec-kpi-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
                gap:.9rem; margin-bottom:1.2rem; }
.rec-kpi { background:var(--surface); border-radius:12px; padding:.9rem 1rem;
           border:1px solid var(--border); border-top:3px solid var(--border); }
.rec-kpi.rv  { border-top-color:var(--verde); }
.rec-kpi.ra  { border-top-color:var(--amarillo); }
.rec-kpi.rn  { border-top-color:var(--naranja); }
.rec-kpi.rr  { border-top-color:var(--rojo); }
.rec-kpi.rb  { border-top-color:var(--accent); }
.rk-label { font-size:.63rem; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:var(--text-muted); margin-bottom:.3rem; }
.rk-value { font-size:1.3rem; font-weight:800; color:var(--text); line-height:1; }
.rk-sub   { font-size:.68rem; color:var(--text-muted); margin-top:.25rem; }

/* ── Priority table ── */
.pri-covered { background:rgba(76,175,125,.05); }
.pri-partial { background:rgba(201,168,76,.05); }

/* ── Animations ── */
@keyframes fadeIn { from { opacity:0; transform: translateY(-8px); } to { opacity:1; transform:none; } }

/* ── PDF / Print button ── */
.pdf-btn { width: 100%; margin-top: .4rem; background: transparent;
           color: var(--text-muted); border: 1px solid var(--border); border-radius: 6px;
           padding: .45rem; font-size: .82rem; font-weight: 600; cursor: pointer;
           transition: all .15s; display: flex; align-items: center;
           justify-content: center; gap: .4rem; }
.pdf-btn:hover { border-color: var(--accent); color: var(--accent); }

/* ── TokenOriginate branding ── */
.sb-branding { display: flex; align-items: center; gap: .75rem; margin-bottom: 1.1rem; }
.sb-logo-name { color: white; font-size: 1.05rem; font-weight: 800; letter-spacing: -.3px; line-height: 1.1; }
.sb-logo-name span { color: var(--accent); font-weight: 300; letter-spacing: .02em; }
.sb-logo-tag  { color: var(--accent); font-size: .62rem; font-weight: 700; text-transform: uppercase;
                letter-spacing: .9px; margin-top: .1rem; opacity: .75; }
.sb-logo-platform { color: var(--text-muted); font-size: .58rem; font-weight: 600;
                    text-transform: uppercase; letter-spacing: .06em; margin-top: .05rem; }

/* ── PDF Cover page ── */
#pdf-cover {
  display: none;
  position: fixed; inset: 0; z-index: 9999;
  background: var(--bg);
  flex-direction: column; align-items: center; justify-content: center;
  font-family: 'Inter', 'Segoe UI', Arial, sans-serif; color: var(--text);
}
.cover-grid-bg {
  position: absolute; inset: 0; opacity: .025;
  background-image: linear-gradient(var(--border) 1px, transparent 1px),
                    linear-gradient(90deg, var(--border) 1px, transparent 1px);
  background-size: 40px 40px;
}
.cover-accent-bar {
  position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--accent2), var(--accent));
}
.cover-accent-bottom {
  position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--accent2), var(--accent));
}
.cover-logo-wrap { display: flex; align-items: center; gap: 1.2rem; margin-bottom: 2.5rem; }
.cover-company   { font-size: 2.8rem; font-weight: 900; letter-spacing: -1px; color: white; }
.cover-company span { color: var(--accent); font-weight: 300; }
.cover-tagline   { font-size: .9rem; font-weight: 600; color: var(--accent); text-transform: uppercase;
                   letter-spacing: 2px; margin-top: .2rem; opacity: .8; }
.cover-platform  { font-size: .7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase;
                   letter-spacing: .1em; margin-top: .15rem; }
.cover-divider   { width: 80px; height: 2px;
                   background: linear-gradient(90deg, transparent, var(--accent), transparent);
                   border-radius: 2px; margin: 2rem 0; }
.cover-report    { font-size: 1.55rem; font-weight: 800; color: var(--text);
                   text-align: center; letter-spacing: -.5px; }
.cover-sub       { font-size: .95rem; color: var(--text-muted); margin-top: .6rem; text-align: center; }
.cover-meta      { display: flex; gap: 2.5rem; margin-top: 3rem; }
.cover-meta-item { text-align: center; }
.cover-meta-item .cm-label { font-size: .65rem; font-weight: 700; text-transform: uppercase;
                              letter-spacing: 1px; color: var(--text-muted); margin-bottom: .3rem; }
.cover-meta-item .cm-value { font-size: .95rem; font-weight: 700; color: var(--text); }
.cover-footer-txt { position: absolute; bottom: 1.5rem; font-size: .72rem;
                    color: var(--text-muted); text-align: center; letter-spacing: .5px; }

/* ── PDF Summary / Legal pages ── */
#pdf-summary, #pdf-legal {
  display: none;
  position: fixed; inset: 0; z-index: 9998;
  background: var(--bg);
  flex-direction: column;
  font-family: 'Inter', 'Segoe UI', Arial, sans-serif; color: var(--text);
  padding: 3rem 5rem;
}
.pdf-page-header { border-bottom: 1px solid var(--border); padding-bottom: 1rem; margin-bottom: 2rem;
                   display: flex; justify-content: space-between; align-items: center; }
.pdf-page-header .ph-logo { font-size: 1rem; font-weight: 800; color: white; }
.pdf-page-header .ph-logo span { color: var(--accent); font-weight: 300; }
.pdf-page-header .ph-sub { font-size: .7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: .08em; }
.pdf-page-title { font-size: 1.6rem; font-weight: 800; color: var(--text); margin-bottom: 1.5rem; }
.pdf-page-text  { font-size: .9rem; color: var(--text); line-height: 1.8; margin-bottom: 1.2rem; }
.pdf-legal-title { font-size: .65rem; font-weight: 800; text-transform: uppercase; letter-spacing: .1em;
                   color: var(--accent); margin-bottom: .5rem; margin-top: 1.2rem; }
.pdf-legal-text  { font-size: .75rem; color: var(--text-muted); line-height: 1.7; }
.pdf-legal-footer { margin-top: auto; padding-top: 2rem; border-top: 1px solid var(--border);
                    font-size: .7rem; color: var(--text-muted); }

/* ── Score Badge SVG ── */
.badge-wrap { display:flex; flex-direction:column; align-items:center; justify-content:center; height:220px; }
.badge-arc  { fill:none; stroke-width:10; stroke-linecap:round;
              transition: stroke-dashoffset .9s ease, stroke .4s; }
/* ── Report header ── */
.report-header { background:var(--surface); border-radius:12px; padding:.85rem 1.4rem;
                 margin-bottom:1.1rem; border:1px solid var(--border);
                 display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap; }
.rh-left  { display:flex; align-items:center; gap:.8rem; flex:1; min-width:200px; }
.rh-right { display:flex; gap:1.8rem; }
.rh-meta  { text-align:right; }
.rh-meta .rh-lbl { font-size:.62rem; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:var(--text-muted); }
.rh-meta .rh-val { font-size:.88rem; font-weight:800; color:var(--accent); }
.empresa-input { border:1px solid var(--border); border-radius:6px; padding:.32rem .65rem;
                 font-size:.88rem; font-family:inherit; font-weight:600; color:var(--text);
                 flex:1; max-width:280px; outline:none; background:var(--surface2); }
.empresa-input:focus { border-color:var(--accent); }
/* ── Credit history section ── */
.hist-row { display:flex; justify-content:space-between; align-items:center;
            padding:.45rem 0; border-bottom:1px solid var(--border); font-size:.85rem; }
.hist-row:last-child { border-bottom:none; }
.hist-lbl { color:var(--text-muted); }
.hist-val { font-weight:700; color:var(--text); }
.hist-penalty { color:var(--rojo); }
.hist-bonus   { color:var(--verde); }
.hist-neutral { color:var(--text-muted); }
/* ── PDF upload button ── */
.pdf-upload-btn { width:100%; margin-top:.4rem; background:transparent;
                  color:var(--text-muted); border:1px solid var(--border); border-radius:6px;
                  padding:.45rem; font-size:.82rem; font-weight:600; cursor:pointer;
                  transition:all .15s; display:flex; align-items:center;
                  justify-content:center; gap:.4rem; }
.pdf-upload-btn:hover { border-color:var(--accent); color:var(--accent); }
/* ── Working Capital tiles ── */
.wc-summary-row { display:flex; justify-content:space-between; align-items:center;
                  padding:.5rem 0; border-bottom:1px solid var(--border); }
.wc-summary-row:last-child { border-bottom:none; }

/* ── Print-header typography ── */
.ph-brand   { font-weight:800; font-size:.9rem; color:white; }
.ph-accent  { color:#c9a84c; font-weight:300; }
.ph-sub     { font-size:.7rem; color:#55556a; text-transform:uppercase; letter-spacing:.06em; }
.ph-label   { font-size:.72rem; color:#55556a; }

/* ── Print (white, professional financial report) ── */
@media print {
  @page { size: A4 portrait; margin: 2.5cm 2.8cm 2.2cm 2.8cm; }

  /* ── Override all CSS variables to white/light for print ── */
  :root {
    --bg:         #ffffff;
    --surface:    #ffffff;
    --surface2:   #f5f5f5;
    --border:     #e0e0e0;
    --text:       #111111;
    --text-muted: #888888;
    --verde:      #2e7d4f;
    --amarillo:   #9a6f00;
    --naranja:    #b85c00;
    --rojo:       #b82222;
  }

  *, *::before, *::after {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }

  /* ── Page frame: gold top bar that repeats on every page ── */
  #print-frame { display: block !important; }
  .pf-top {
    position: fixed; top: 0; left: 0; right: 0; height: 4px;
    background: #c9a84c; z-index: 9999;
  }
  .pf-bottom {
    position: fixed; bottom: 0; left: 0; right: 0; height: 24px;
    background: white; border-top: 1px solid #ebebeb;
    display: flex !important; align-items: center;
    justify-content: space-between; padding: 0 1.8rem;
    font-family: 'Inter', sans-serif; font-size: 7.5px;
    color: #aaa; letter-spacing: .06em; z-index: 9999;
  }

  /* ── Global white override ── */
  body { background: #ffffff !important; color: #111 !important;
         overflow: auto; display: block; }
  #sidebar { display: none !important; }
  #main { overflow: visible; padding: 0 .6rem; width: 100%; }
  .tabs, .action-btn, .reset-btn, .pdf-btn,
  .pdf-upload-btn, .ex-btns { display: none !important; }

  /* ── Print header ── */
  .print-header { display: flex !important; margin-bottom: .9rem;
                  padding-bottom: .5rem; background: white !important;
                  border-bottom: 1px solid #ebebeb !important; }
  .ph-brand   { color: #111 !important; }
  .ph-sub     { color: #999 !important; }
  .ph-label   { color: #999 !important; }
  .print-header .ph-logo-hex { fill: white !important; }

  /* ── Cover page ── */
  #pdf-cover {
    display: flex !important; position: relative !important;
    width: 100% !important; height: 100vh !important;
    page-break-after: always !important; break-after: page !important;
    background: #ffffff !important; color: #111 !important;
    box-sizing: border-box !important;
  }
  .cover-grid-bg    { display: none !important; }
  .cover-accent-bar { background: #c9a84c !important; height: 5px !important; }
  .cover-accent-bottom { background: #c9a84c !important; height: 1px !important; }
  .cover-company    { color: #111 !important; }
  .cover-company span { color: #c9a84c !important; }
  .cover-tagline    { color: #c9a84c !important; }
  .cover-platform   { color: #999 !important; }
  .cover-report     { color: #111 !important; }
  .cover-sub        { color: #666 !important; }
  .cm-label         { color: #999 !important; }
  .cm-value         { color: #111 !important; }
  .cover-footer-txt { color: #bbb !important; }
  .cover-divider    { background: #c9a84c !important; }
  #pdf-cover polygon { fill: #f5f5f5 !important; }

  /* ── Summary / Legal pages ── */
  #pdf-summary, #pdf-legal {
    display: flex !important; position: relative !important;
    width: 100% !important; height: 100vh !important;
    page-break-after: always !important; break-after: page !important;
    background: #ffffff !important; color: #111 !important;
    padding: 3.5rem 4rem 3rem !important;
    flex-direction: column !important; box-sizing: border-box !important;
  }
  .pdf-page-header { border-bottom-color: #ebebeb !important; }
  .pdf-page-header .ph-logo { color: #111 !important; }
  .pdf-page-header .ph-logo span { color: #c9a84c !important; }
  .pdf-page-header .ph-sub  { color: #999 !important; }
  .pdf-page-title   { color: #111 !important; }
  .pdf-page-text    { color: #333 !important; }
  .pdf-legal-title  { color: #c9a84c !important; }
  .pdf-legal-text   { color: #444 !important; }
  .pdf-legal-footer { color: #999 !important; border-top-color: #ebebeb !important; }

  /* ── Sections ── */
  .section { display: block !important; margin-bottom: 0; }
  #tab-scoring { page-break-before: avoid; }
  #tab-wc, #tab-nueva_deuda, #tab-comparables,
  #tab-covenants, #tab-colateral, #tab-detalle {
    page-break-before: always; break-before: page;
  }
  .section::before {
    content: attr(data-title); display: block;
    font-size: .58rem; font-weight: 800; text-transform: uppercase;
    letter-spacing: .16em; color: #c9a84c;
    border-bottom: 1.5px solid #c9a84c; padding-bottom: .4rem; margin-bottom: 1rem;
  }

  /* ── Cards → white ── */
  .card { background: white !important; border: 1px solid #ebebeb !important;
          page-break-inside: avoid !important; break-inside: avoid !important;
          margin-bottom: .7rem !important; }
  .card-title { color: #999 !important; }

  /* ── KPI strip ── */
  .kpi { background: white !important; border: 1px solid #ebebeb !important; }
  .kpi .k-value { color: #111 !important; }
  .kpi .k-label, .kpi .k-sub { color: #999 !important; }

  /* ── Ratio tiles ── */
  .ratio-tile { background: white !important;
                border: 1px solid #ebebeb !important;
                border-left: 3px solid #ebebeb !important;
                page-break-inside: avoid !important; break-inside: avoid !important; }
  .ratio-tile.verde    { border-left-color: #287d4e !important; }
  .ratio-tile.amarillo { border-left-color: #9b6c0a !important; }
  .ratio-tile.naranja  { border-left-color: #b44d19 !important; }
  .ratio-tile.rojo     { border-left-color: #b52828 !important; }
  .rt-value { color: #111 !important; }
  .rt-label, .rt-sub { color: #999 !important; }
  .verde    .rt-score { background: #eaf5ef !important; color: #287d4e !important; }
  .amarillo .rt-score { background: #fdf4e0 !important; color: #9b6c0a !important; }
  .naranja  .rt-score { background: #fdeee6 !important; color: #b44d19 !important; }
  .rojo     .rt-score { background: #fde8e8 !important; color: #b52828 !important; }

  /* ── Recommendation banner ── */
  .rec-banner, .rec-banner.verde, .rec-banner.amarillo, .rec-banner.rojo { border: none !important; }
  .rec-banner.verde   { background: #f1faf5 !important; border-left: 5px solid #287d4e !important; }
  .rec-banner.amarillo{ background: #fef9ed !important; border-left: 5px solid #9b6c0a !important; }
  .rec-banner.rojo    { background: #fef1f1 !important; border-left: 5px solid #b52828 !important; }
  .rec-body .rec-text  { color: #333 !important; }
  .rec-body .rec-label { color: #999 !important; }
  .verde .rec-decision    { color: #287d4e !important; }
  .amarillo .rec-decision { color: #9b6c0a !important; }
  .rojo .rec-decision     { color: #b52828 !important; }

  /* ── Tables ── */
  .sect-table th, .det-table th, .col-table th {
    background: #f5f5f5 !important; color: #666 !important;
  }
  .sect-table td, .det-table td, .col-table td {
    color: #111 !important; border-color: #ebebeb !important;
  }
  .sect-table tr:nth-child(even) td { background: #fafafa !important; }
  .det-table  tr:nth-child(even) td { background: #fafafa !important; }
  .sect-table tr.company-row td     { background: #fdf9ee !important; color: #9b6c0a !important; }
  .pos-p25 { color: #287d4e !important; }
  .pos-med { color: #9b6c0a !important; }
  .pos-p75 { color: #b52828 !important; }
  .pos-good{ color: #287d4e !important; }
  .pos-mid { color: #9b6c0a !important; }
  .pos-bad { color: #b52828 !important; }

  /* ── Report header ── */
  .report-header { background: white !important; border-color: #ebebeb !important; }
  .rh-meta .rh-lbl { color: #999 !important; }
  .rh-meta .rh-val { color: #c9a84c !important; }
  .empresa-input   { background: white !important; color: #111 !important;
                     border-color: #ebebeb !important; }

  /* ── Gating banner ── */
  .gating-banner { background: #fff5f5 !important; border-color: #f5cccc !important; }
  .gating-banner .g-title { color: #b52828 !important; }
  .gating-banner .g-text  { color: #333 !important; }

  /* ── Risk cards ── */
  .risk-card { background: white !important; border-color: #ebebeb !important;
               border-left-color: #b52828 !important; }
  .risk-card .r-rank, .risk-card .r-impact { color: #b52828 !important; }
  .risk-card .r-name  { color: #111 !important; }
  .risk-card .r-value { color: #666 !important; }

  /* ── Covenant cards ── */
  .cov-card  { background: white !important; border-color: #ebebeb !important;
               border-left-color: #c9a84c !important; }
  .cov-name  { color: #999 !important; }
  .cov-value { color: #111 !important; }
  .cov-desc  { color: #999 !important; }

  /* ── Pricing ── */
  .pricing-card { background: #f8f8f8 !important; border-color: #ebebeb !important; }
  .pricing-card.active-price { background: #fdf9ee !important; border-color: #c9a84c !important; }
  .pc-tranche { color: #999 !important; }
  .pc-spread  { color: #c9a84c !important; }
  .pc-note    { color: #999 !important; }

  /* ── Nueva Deuda ── */
  .nd-result { background: white !important; border-color: #ebebeb !important; }
  .nd-lbl    { color: #999 !important; }
  .nd-val    { color: #111 !important; }
  .nd-row    { border-color: #ebebeb !important; }
  .nd-ok     { background: #eaf5ef !important; color: #287d4e !important; }
  .nd-warn   { background: #fdf4e0 !important; color: #9b6c0a !important; }
  .nd-bad    { background: #fde8e8 !important; color: #b52828 !important; }

  /* ── Recovery KPI cards ── */
  .rec-kpi   { background: white !important; border-color: #ebebeb !important;
               border-top: 3px solid #ebebeb !important; }
  .rec-kpi.rv{ border-top-color: #287d4e !important; }
  .rec-kpi.ra{ border-top-color: #9b6c0a !important; }
  .rec-kpi.rn{ border-top-color: #b44d19 !important; }
  .rec-kpi.rr{ border-top-color: #b52828 !important; }
  .rec-kpi.rb{ border-top-color: #c9a84c !important; }
  .rk-value  { color: #111 !important; }
  .rk-label, .rk-sub { color: #999 !important; }

  /* ── Colateral table ── */
  .col-table tfoot td { color: #111 !important; border-top: 2px solid #ebebeb !important; }
  .col-haircut { color: #b44d19 !important; }
  .col-neto    { color: #111 !important; }
  .col-del-btn { display: none !important; }

  /* ── Badges ── */
  .badge-v { background: #eaf5ef !important; color: #287d4e !important; }
  .badge-a { background: #fdf4e0 !important; color: #9b6c0a !important; }
  .badge-r { background: #fde8e8 !important; color: #b52828 !important; }
  .badge-n { background: #fdeee6 !important; color: #b44d19 !important; }
  .badge-g { background: #fdf4e0 !important; color: #9b6c0a !important; }
  .gating-badge { background: #fdf4e0 !important; color: #9b6c0a !important; }
  .ltv-ok   { background: #eaf5ef !important; color: #287d4e !important; }
  .ltv-warn { background: #fdf4e0 !important; color: #9b6c0a !important; }
  .ltv-bad  { background: #fde8e8 !important; color: #b52828 !important; }

  /* ── Credit history ── */
  .hist-row  { border-color: #ebebeb !important; }
  .hist-lbl  { color: #999 !important; }
  .hist-val  { color: #111 !important; }
  .hist-penalty { color: #b52828 !important; }
  .hist-bonus   { color: #287d4e !important; }

  /* ── WC rows ── */
  .wc-summary-row { border-color: #ebebeb !important; }

  /* ── Priority table ── */
  .pri-covered { background: #f1faf5 !important; }
  .pri-partial { background: #fef9ed !important; }

  /* ── Score badge SVG text ── */
  #badge-score     { fill: #111 !important; }
  #badge-rating-desc { fill: #999 !important; }

  /* ── Compact layout grids ── */
  .ratio-grid { grid-template-columns: repeat(4, 1fr) !important; gap: .4rem !important; }
  .kpi-strip  { grid-template-columns: repeat(4, 1fr) !important; gap: .5rem !important; }
  .score-row  { grid-template-columns: 210px 1fr !important; gap: .8rem !important; }
  .chart-grid { grid-template-columns: 1fr 1fr !important; gap: .7rem !important; }
  .risk-grid  { grid-template-columns: repeat(3, 1fr) !important; gap: .5rem !important; }
  .cov-grid   { grid-template-columns: repeat(3, 1fr) !important; gap: .5rem !important; }

  /* ── Chart heights ── */
  #bar-chart      { height: 240px !important; min-height: 240px !important; }
  #radar-chart    { height: 260px !important; min-height: 260px !important; }
  #wc-cycle-chart { height: 200px !important; min-height: 200px !important; }
  #sect-chart     { height: 250px !important; min-height: 250px !important; }
  #col-waterfall  { height: 230px !important; min-height: 230px !important; }
  .badge-wrap { height: 180px !important; }

  * { box-shadow: none !important; text-shadow: none !important; }
  .ratio-tile:hover { transform: none !important; }
}
</style>
</head>
<body>

<!-- ═══════════════════════════ PDF COVER ═══════════════════════════ -->
<div id="pdf-cover">
  <div class="cover-grid-bg"></div>
  <div class="cover-accent-bar"></div>
  <div class="cover-accent-bottom"></div>
  <div class="cover-logo-wrap">
    <!-- TokenOriginate Hexagon Logo SVG -->
    <svg width="72" height="72" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
      <polygon points="28,3 52,15.5 52,40.5 28,53 4,40.5 4,15.5" fill="#0a0a0f" stroke="#c9a84c" stroke-width="2"/>
      <line x1="15" y1="28" x2="37" y2="28" stroke="#c9a84c" stroke-width="2.5" stroke-linecap="round"/>
      <polyline points="31,21 39,28 31,35" fill="none" stroke="#c9a84c" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <div>
      <div class="cover-company">TOKEN<span>ORIGINATE</span></div>
      <div class="cover-tagline">Credit Risk</div>
      <div class="cover-platform">Platform</div>
    </div>
  </div>
  <div class="cover-divider"></div>
  <div class="cover-report">Credit Risk Scoring Report</div>
  <div class="cover-sub" id="cover-empresa-sub">PYMEs Industriales — Modelo v2.0 | Análisis de Riesgo Crediticio</div>
  <div class="cover-meta">
    <div class="cover-meta-item">
      <div class="cm-label">Fecha de análisis</div>
      <div class="cm-value" id="cover-date">—</div>
    </div>
    <div class="cover-meta-item">
      <div class="cm-label">Nº Informe</div>
      <div class="cm-value" id="cover-report-num">TO-—</div>
    </div>
    <div class="cover-meta-item">
      <div class="cm-label">Clasificación</div>
      <div class="cm-value">Uso Interno</div>
    </div>
  </div>
  <div class="cover-footer-txt">© TokenOriginate 2026 · info@tokenoriginate.com — Documento confidencial. Solo para uso interno y análisis orientativo.</div>
</div>

<!-- ═══════════════════════════ PDF SUMMARY PAGE ═══════════════════════════ -->
<div id="pdf-summary">
  <div class="pdf-page-header">
    <div class="ph-logo">TOKEN<span>ORIGINATE</span></div>
    <div class="ph-sub">Credit Risk Platform · Resumen Ejecutivo</div>
  </div>
  <div class="pdf-page-title">Resumen Ejecutivo</div>
  <p class="pdf-page-text">
    TokenOriginate es una plataforma de análisis de riesgo crediticio especializada en PYMEs industriales.
    Mediante un modelo cuantitativo de 11 métricas ponderadas — que combina ratios de cobertura de deuda,
    apalancamiento, liquidez y factores cualitativos — genera una puntuación de riesgo (0–100) y una
    calificación equivalente a la escala S&amp;P. El análisis se complementa con comparables sectoriales,
    generación automática de covenants y análisis de colateral.
  </p>
  <p class="pdf-page-text" id="pdf-summary-empresa">
    El presente informe analiza la operación de crédito propuesta, evaluando la capacidad de servicio de la
    deuda, el perfil de apalancamiento y los factores cualitativos del equipo directivo, base de clientes
    y estabilidad sectorial. Los resultados se presentan con el score final, la recomendación de crédito
    y los principales factores de riesgo identificados.
  </p>
</div>

<!-- ═══════════════════════════ PDF LEGAL PAGE ═══════════════════════════ -->
<div id="pdf-legal">
  <div class="pdf-page-header">
    <div class="ph-logo">TOKEN<span>ORIGINATE</span></div>
    <div class="ph-sub">Credit Risk Platform · Aviso Legal</div>
  </div>
  <div class="pdf-page-title">Aviso Legal y Limitaciones</div>
  <div class="pdf-legal-title">AVISO LEGAL Y LIMITACIONES</div>
  <p class="pdf-legal-text">
    Este informe ha sido elaborado por TokenOriginate con carácter exclusivamente orientativo e interno.
    No constituye asesoramiento financiero, oferta de financiación ni compromiso de concesión de crédito.
    La información contenida en este documento se basa en los datos proporcionados por el cliente o
    introducidos manualmente, sin verificación independiente por parte de TokenOriginate.
  </p>
  <div class="pdf-legal-title">RESPONSABILIDAD</div>
  <p class="pdf-legal-text">
    TokenOriginate no asume responsabilidad alguna por decisiones de crédito adoptadas basándose
    exclusivamente en este informe. El análisis debe ser completado con due diligence adicional,
    verificación documental y el juicio profesional del analista de riesgo responsable.
    Los modelos de scoring utilizados son herramientas de apoyo a la decisión y no sustituyen
    el criterio experto ni la política de riesgos de la entidad financiadora.
  </p>
  <div class="pdf-legal-title">CONFIDENCIALIDAD</div>
  <p class="pdf-legal-text">
    Este documento es confidencial y está destinado exclusivamente al uso interno de la entidad
    financiadora. Queda prohibida su reproducción, distribución o divulgación a terceros sin
    autorización expresa y por escrito de TokenOriginate.
  </p>
  <div class="pdf-legal-footer">
    © TokenOriginate 2026 · info@tokenoriginate.com<br>
    Documento generado automáticamente. Uso interno y análisis orientativo únicamente.
  </div>
</div>

<!-- ═══════════════════════════ SIDEBAR ═══════════════════════════ -->
<div id="sidebar">
  <!-- TokenOriginate brand -->
  <div class="sb-branding">
    <svg width="38" height="38" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
      <polygon points="28,3 52,15.5 52,40.5 28,53 4,40.5 4,15.5" fill="#111118" stroke="#c9a84c" stroke-width="2"/>
      <line x1="15" y1="28" x2="37" y2="28" stroke="#c9a84c" stroke-width="2.5" stroke-linecap="round"/>
      <polyline points="31,21 39,28 31,35" fill="none" stroke="#c9a84c" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <div>
      <div class="sb-logo-name">TOKEN<span>ORIGINATE</span></div>
      <div class="sb-logo-tag">Credit Risk</div>
      <div class="sb-logo-platform">Platform</div>
    </div>
  </div>

  <!-- Example buttons -->
  <div class="sb-sec">Cargar ejemplo</div>
  <div class="ex-btns">
    <button class="ex-btn" onclick="loadExample('tubacex')">Tubacex</button>
    <button class="ex-btn" onclick="loadExample('aa')">Perfil AA</button>
    <button class="ex-btn" onclick="loadExample('c')">Perfil C</button>
  </div>
  <hr class="sb-sep">

  <!-- P&L -->
  <div class="sb-sec">Cuenta de Resultados (M€)</div>
  <div class="field"><label>Ventas netas</label><input type="number" id="ventas" step="0.1" value="100"></div>
  <div class="field"><label>EBITDA reportado</label><input type="number" id="ebitda" step="0.1" value="15"></div>
  <div class="field"><label>Gastos financieros</label><input type="number" id="gastos_fin" step="0.1" value="2.5"></div>
  <div class="field"><label>Impuesto pagado (caja)</label><input type="number" id="imp_pagado" step="0.1" value="2"></div>
  <div class="field"><label>Capex mantenimiento</label><input type="number" id="capex_mant" step="0.1" value="2"></div>

  <hr class="sb-sep">
  <!-- Balance -->
  <div class="sb-sec">Balance (M€)</div>
  <div class="field"><label>Deuda financiera bruta</label><input type="number" id="deuda_bruta" step="0.1" value="35"></div>
  <div class="field"><label>Caja y equiv.</label><input type="number" id="caja" step="0.1" value="8"></div>
  <div class="field"><label>Activo corriente</label><input type="number" id="activo_corriente" step="0.1" value="45"></div>
  <div class="field"><label>Pasivo corriente</label><input type="number" id="pasivo_corriente" step="0.1" value="28"></div>
  <div class="field"><label>Clientes (cobrar)</label><input type="number" id="clientes" step="0.1" value="22"></div>
  <div class="field"><label>Proveedores (pagar)</label><input type="number" id="proveedores" step="0.1" value="18"></div>
  <div class="field"><label>Inventario (M€)</label><input type="number" id="inventario" step="0.1" value="0"></div>
  <div class="field"><label>Aprovisionamientos (M€)</label><input type="number" id="aprovisionamientos" step="0.1" value="0"></div>
  <div class="field"><label>Vida media deuda (años)</label><input type="number" id="vida_media" step="0.5" value="5"></div>

  <hr class="sb-sep">
  <!-- Operación nueva -->
  <div class="sb-sec">Operación Nueva (opcional)</div>
  <div class="field">
    <label>Finalidad del préstamo</label>
    <select id="finalidad">
      <option value="maquinaria">Adquisición maquinaria / Capex</option>
      <option value="circulante">Financiación circulante</option>
      <option value="refinanciacion">Refinanciación deuda existente</option>
      <option value="ma">M&amp;A / Adquisición empresa</option>
      <option value="internacional">Expansión internacional</option>
      <option value="idi">I+D+i / Innovación</option>
      <option value="otro">Otro / General</option>
    </select>
  </div>
  <div class="field"><label>Importe solicitado (M€)</label><input type="number" id="importe" step="0.1" value="0" oninput="updateLtvIndicator()"></div>
  <div class="field"><label>Plazo (años)</label><input type="number" id="plazo" step="1" value="5"></div>
  <div class="field"><label>Tipo interés (%)</label><input type="number" id="tipo_int" step="0.1" value="6"></div>

  <hr class="sb-sep">
  <!-- Colateral -->
  <div class="sb-sec">Colateral</div>
  <div class="field"><label>Valor colateral (M€)</label><input type="number" id="colateral" step="0.1" value="0" oninput="updateLtvIndicator()"></div>
  <div class="field">
    <label>Tipo colateral</label>
    <select id="tipo_col" onchange="updateLtvIndicator()">
      <option value="inmueble">Inmueble (LTV máx. 60%)</option>
      <option value="maquinaria">Maquinaria (LTV máx. 40%)</option>
      <option value="cuentas_cobrar">Cuentas a cobrar (LTV máx. 70%)</option>
      <option value="stock">Stock (LTV máx. 50%)</option>
      <option value="mixto">Mixto (LTV máx. 55%)</option>
      <option value="ninguno">Sin colateral</option>
    </select>
  </div>
  <div id="ltv-indicator" class="ltv-indicator"></div>

  <hr class="sb-sep">
  <!-- Historial Crediticio -->
  <div class="sb-sec">Historial Crediticio</div>
  <div class="field">
    <label>RAI / Morosidad</label>
    <select id="rai">
      <option value="ninguna">Sin incidencias en RAI</option>
      <option value="antiguas">Incidencias antiguas (&gt;3 años)</option>
      <option value="activas">Incidencias activas en RAI</option>
    </select>
  </div>
  <div class="field">
    <label>ASNEF</label>
    <select id="asnef">
      <option value="no">No consta en ASNEF</option>
      <option value="si">Consta en ASNEF</option>
    </select>
  </div>
  <div class="field">
    <label>Impagos históricos</label>
    <select id="impagos">
      <option value="ninguno">Sin impagos</option>
      <option value="puntual">Impago puntual (1–2)</option>
      <option value="recurrente">Impagos recurrentes (&gt;2)</option>
    </select>
  </div>
  <div class="field">
    <label>Demandas judiciales</label>
    <select id="demandas">
      <option value="ninguna">Sin demandas</option>
      <option value="menor">Demanda menor (&lt;50k€)</option>
      <option value="relevante">Demanda relevante (&gt;50k€)</option>
    </select>
  </div>
  <div class="field">
    <label>Relación bancaria</label>
    <select id="relacion_bancaria">
      <option value="buena">Buena (5+ años sin incidencias)</option>
      <option value="normal">Normal</option>
      <option value="deteriorada">Deteriorada o tensa</option>
    </select>
  </div>
  <div class="field"><label>Años sin incidencias</label><input type="number" id="anios_sin_incidencias" value="0" min="0" max="30" step="1"></div>

  <hr class="sb-sep">
  <!-- Cualitativos -->
  <div class="sb-sec">Factores Cualitativos (1–5)</div>
  <div class="field">
    <label>Equipo directivo</label>
    <select id="equipo">
      <option value="3">3 – Competente</option>
      <option value="1">1 – Deficiente</option>
      <option value="2">2 – Limitado</option>
      <option value="4">4 – Sólido</option>
      <option value="5">5 – Excelente</option>
    </select>
  </div>
  <div class="field">
    <label>Diversif. clientes</label>
    <select id="concentracion">
      <option value="3">3 – Media (top-3 ~50%)</option>
      <option value="1">1 – Muy alta (top-1 > 60%)</option>
      <option value="2">2 – Alta (top-3 > 70%)</option>
      <option value="4">4 – Baja (top-3 < 40%)</option>
      <option value="5">5 – Muy baja (top-3 < 20%)</option>
    </select>
  </div>
  <div class="field">
    <label>Antigüedad negocio</label>
    <select id="antiguedad">
      <option value="3">3 – 10–20 años</option>
      <option value="1">1 – < 3 años</option>
      <option value="2">2 – 3–10 años</option>
      <option value="4">4 – 20–30 años</option>
      <option value="5">5 – > 30 años</option>
    </select>
  </div>
  <div class="field">
    <label>Estabilidad sector</label>
    <select id="ciclicidad">
      <option value="3">3 – Moderada</option>
      <option value="1">1 – Muy cíclico</option>
      <option value="2">2 – Cíclico</option>
      <option value="4">4 – Estable</option>
      <option value="5">5 – Muy defensivo</option>
    </select>
  </div>

  <hr class="sb-sep">
  <!-- Sector comparables -->
  <div class="sb-sec">Sector para comparables</div>
  <div class="field">
    <select id="sector_comp">
      <option value="metalurgia">Metalurgia / Fab. metal</option>
      <option value="quimica">Química / Plásticos</option>
      <option value="alimentacion">Alimentación / Bebidas</option>
      <option value="automocion">Automoción / Componentes</option>
      <option value="papel_carton">Papel / Cartón</option>
      <option value="construccion">Construcción industrial</option>
      <option value="energia">Energía / Renovables</option>
      <option value="logistica">Logística / Transporte</option>
    </select>
  </div>

  <hr class="sb-sep">
  <button class="pdf-upload-btn" onclick="document.getElementById('pdf-file-input').click()">📄 Subir estados financieros (PDF)</button>
  <input type="file" id="pdf-file-input" accept=".pdf" style="display:none" onchange="processPDF(this)">
  <button class="action-btn" onclick="update()">Calcular scoring</button>
  <button class="reset-btn" onclick="resetForm()">Nueva valoración</button>
  <button class="pdf-btn" onclick="exportPDF()">⬇ Descargar PDF</button>
</div>

<!-- ═══════════════════════════ MAIN ═══════════════════════════ -->
<div id="main">
  <!-- Print-only header strip (appears on every page after cover) -->
  <div class="print-header" style="display:none; justify-content:space-between; align-items:center;
       border-bottom:1px solid var(--border); padding-bottom:.6rem; margin-bottom:1.2rem;">
    <div style="display:flex;align-items:center;gap:.6rem;">
      <svg width="22" height="22" viewBox="0 0 56 56" fill="none">
        <polygon points="28,3 52,15.5 52,40.5 28,53 4,40.5 4,15.5" fill="#111118" stroke="#c9a84c" stroke-width="2" class="ph-logo-hex"/>
        <line x1="15" y1="28" x2="37" y2="28" stroke="#c9a84c" stroke-width="2" stroke-linecap="round"/>
        <polyline points="31,21 39,28 31,35" fill="none" stroke="#c9a84c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="ph-brand">TOKEN<span class="ph-accent">ORIGINATE</span></span>
      <span class="ph-sub">Credit Risk Platform</span>
    </div>
    <span class="ph-label">Credit Risk Scoring Report — Confidencial</span>
  </div>

  <!-- Report header -->
  <div class="report-header">
    <div class="rh-left">
      <span style="font-size:.72rem;font-weight:700;text-transform:uppercase;color:#55556a;letter-spacing:.5px;white-space:nowrap;">Empresa</span>
      <input id="empresa-nombre" class="empresa-input" type="text" placeholder="Nombre de la empresa...">
    </div>
    <div class="rh-right">
      <div class="rh-meta">
        <div class="rh-lbl">Nº Informe</div>
        <div class="rh-val" id="report-number">TO-—</div>
      </div>
      <div class="rh-meta">
        <div class="rh-lbl">Fecha</div>
        <div class="rh-val" style="color:#f0f0f5;" id="report-date">—</div>
      </div>
    </div>
  </div>

  <div class="main-header">
    <div>
      <h1>Credit Risk Scoring</h1>
      <p id="subtitle">TokenOriginate — PYMEs Industriales v2.0 | Solo uso interno y análisis orientativo</p>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active"   onclick="switchTab('scoring')">Scoring</div>
    <div class="tab inactive" onclick="switchTab('wc')">Working Capital</div>
    <div class="tab inactive" onclick="switchTab('nueva_deuda')">Nueva Deuda</div>
    <div class="tab inactive" onclick="switchTab('comparables')">Comparables</div>
    <div class="tab inactive" onclick="switchTab('covenants')">Covenants</div>
    <div class="tab inactive" onclick="switchTab('colateral')">Colateral</div>
    <div class="tab inactive" onclick="switchTab('detalle')">Detalle</div>
  </div>

  <!-- ── TAB: SCORING ── -->
  <div id="tab-scoring" class="section active" data-title="Scoring de Riesgo Crediticio">

    <!-- Gating banner -->
    <div id="gating-banner" class="gating-banner">
      <div class="g-title">⛔ GATING METRIC — RECHAZO AUTOMÁTICO</div>
      <div id="gating-text" class="g-text"></div>
    </div>

    <!-- KPI strip -->
    <div class="kpi-strip">
      <div class="kpi">
        <div class="k-label">EBITDA</div>
        <div class="k-value" id="kpi-ebitda">—</div>
        <div class="k-sub">M€ reportado</div>
      </div>
      <div class="kpi">
        <div class="k-label">Margen EBITDA</div>
        <div class="k-value" id="kpi-margin">—</div>
        <div class="k-sub">% sobre ventas</div>
      </div>
      <div class="kpi">
        <div class="k-label">DFN</div>
        <div class="k-value" id="kpi-dfn">—</div>
        <div class="k-sub">M€ deuda neta</div>
      </div>
      <div class="kpi">
        <div class="k-label">DFN / EBITDA</div>
        <div class="k-value" id="kpi-le">—</div>
        <div class="k-sub">x apalancamiento</div>
      </div>
      <div class="kpi">
        <div class="k-label">DSCR</div>
        <div class="k-value" id="kpi-dscr">—</div>
        <div class="k-sub">x cobertura deuda</div>
      </div>
      <div class="kpi">
        <div class="k-label">LLCR</div>
        <div class="k-value" id="kpi-llcr">—</div>
        <div class="k-sub">x loan life coverage</div>
      </div>
    </div>

    <!-- Score row: badge + bar -->
    <div class="score-row">
      <div class="card">
        <div class="card-title">Score Global</div>
        <div class="badge-wrap">
          <svg width="170" height="170" viewBox="0 0 160 160">
            <circle cx="80" cy="80" r="72" fill="none" stroke="#1f1f2e" stroke-width="10"/>
            <circle id="badge-arc" class="badge-arc" cx="80" cy="80" r="72"
                    stroke="#1f1f2e" stroke-dasharray="452.4" stroke-dashoffset="452.4"
                    transform="rotate(-90 80 80)"/>
            <text id="badge-score" x="80" y="68" text-anchor="middle"
                  font-family="Inter,sans-serif" font-size="34" font-weight="900" fill="#f0f0f5">—</text>
            <text id="badge-rating" x="80" y="94" text-anchor="middle"
                  font-family="Inter,sans-serif" font-size="17" font-weight="700" fill="#55556a">—</text>
            <text id="badge-rating-desc" x="80" y="113" text-anchor="middle"
                  font-family="Inter,sans-serif" font-size="10" fill="#55556a">Score Global</text>
          </svg>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Contribución por Métrica</div>
        <div id="bar-chart" style="height:210px;"></div>
      </div>
    </div>

    <!-- Recommendation banner -->
    <div id="rec-banner" class="rec-banner verde">
      <div class="rec-icon" id="rec-icon">—</div>
      <div class="rec-body">
        <div class="rec-label">Decisión de crédito</div>
        <div class="rec-decision" id="rec-decision">—</div>
        <div class="rec-text" id="rec-text">—</div>
      </div>
    </div>

    <!-- Perfil crediticio -->
    <div id="credit-hist-section" class="card" style="margin-bottom:1.4rem;display:none;">
      <div class="card-title">Perfil Crediticio — Ajuste por Historial</div>
      <div id="credit-hist-content"></div>
    </div>

    <!-- Ratio tiles -->
    <div class="ratio-grid" id="ratio-grid"></div>

    <!-- Radar chart -->
    <div class="card" style="margin-bottom:1.4rem;">
      <div class="card-title">Perfil de Riesgo — Radar</div>
      <div id="radar-chart" style="height:300px;"></div>
    </div>

    <!-- Top risk factors -->
    <div class="card-title" style="margin-bottom:.8rem;">Top 3 Factores de Riesgo</div>
    <div class="risk-grid" id="risk-grid"></div>

  </div><!-- /tab-scoring -->

  <!-- ── TAB: WORKING CAPITAL ── -->
  <div id="tab-wc" class="section" data-title="Análisis Capital Circulante">
    <div class="ratio-grid" id="wc-grid" style="margin-bottom:1.4rem;"></div>
    <div class="card" style="margin-bottom:1.4rem;">
      <div class="card-title">Ciclo de Conversión del Efectivo</div>
      <div id="wc-cycle-chart" style="height:220px;"></div>
    </div>
    <div class="card">
      <div class="card-title">Resumen Capital Circulante</div>
      <div id="wc-summary"></div>
    </div>
  </div>

  <!-- ── TAB: NUEVA DEUDA ── -->
  <div id="tab-nueva_deuda" class="section" data-title="Análisis Nueva Deuda">
    <div class="card" style="margin-bottom:1.2rem;">
      <div class="card-title">Descripción de la Operación</div>
      <div id="nd-finalidad-content"><p style="color:#55556a;font-size:.85rem;">Configure los datos en el panel lateral.</p></div>
    </div>
    <div class="nueva-deuda-grid">
      <div class="nd-result card">
        <div class="card-title">Análisis de Servicio de Deuda Nueva</div>
        <div id="nd-content">
          <p style="color:#55556a;font-size:.85rem;">Introduzca importe, plazo y tipo de interés en el panel lateral para ver el análisis.</p>
        </div>
      </div>
      <div class="nd-result card">
        <div class="card-title">Capacidad de Endeudamiento</div>
        <div id="nd-capacity"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Análisis LTV Colateral</div>
      <div id="nd-ltv"></div>
    </div>
  </div>

  <!-- ── TAB: COMPARABLES ── -->
  <div id="tab-comparables" class="section" data-title="Comparables Sectoriales">
    <div class="card" style="margin-bottom:1.2rem;">
      <div class="card-title">Comparables Sectoriales — <span id="sect-name">—</span></div>
      <div style="overflow-x:auto;">
        <table class="sect-table" id="sect-table">
          <thead><tr>
            <th>Métrica</th>
            <th>P25 Sector</th>
            <th>Mediana Sector</th>
            <th>P75 Sector</th>
            <th>Esta empresa</th>
            <th>Posición</th>
          </tr></thead>
          <tbody id="sect-tbody"></tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Posicionamiento Sectorial</div>
      <div id="sect-chart" style="height:280px;"></div>
    </div>
  </div>

  <!-- ── TAB: COVENANTS ── -->
  <div id="tab-covenants" class="section">
    <div style="margin-bottom:1.2rem;">
      <div class="card-title" style="margin-bottom:.8rem;">Covenants Específicos por Finalidad</div>
      <div class="cov-grid" id="cov-finalidad-grid"></div>
    </div>
    <div style="margin-bottom:1.2rem;">
      <div class="card-title" style="margin-bottom:.8rem;">Covenants Financieros Estándar</div>
      <div class="cov-grid" id="cov-grid"></div>
    </div>
    <div class="card" style="margin-bottom:1.2rem;">
      <div class="card-title">Pricing por Tramo (Spread sobre Euribor)</div>
      <div class="pricing-grid" id="pricing-grid"></div>
      <p id="pricing-note" style="font-size:.78rem;color:#55556a;margin-top:.8rem;"></p>
    </div>
    <div class="card">
      <div class="card-title">Condiciones Adicionales Recomendadas</div>
      <div id="cov-extra"></div>
    </div>
  </div>

  <!-- ── TAB: COLATERAL ── -->
  <div id="tab-colateral" class="section" data-title="Análisis de Colateral y Recovery">

    <!-- S1: Inventory -->
    <div class="card" style="margin-bottom:1.2rem;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <div class="card-title" style="margin-bottom:0;">Sección 1 — Inventario de Colaterales</div>
        <button onclick="addColRow()" style="background:#c9a84c;color:#0a0a0f;border:none;border-radius:8px;padding:.4rem .9rem;font-size:.8rem;font-weight:700;cursor:pointer;">+ Añadir activo</button>
      </div>
      <div style="overflow-x:auto;">
        <table class="col-table">
          <thead><tr>
            <th>Tipo de activo</th>
            <th>Descripción</th>
            <th style="text-align:right;">Valor bruto (M€)</th>
            <th style="text-align:center;">Haircut</th>
            <th style="text-align:right;">Valor neto (M€)</th>
            <th>Tiempo ejecución</th>
            <th></th>
          </tr></thead>
          <tbody id="col-tbody">
            <tr id="col-empty"><td colspan="7" style="text-align:center;color:#55556a;padding:1.8rem;font-size:.85rem;">Sin activos. Pulsa "+ Añadir activo" para comenzar.</td></tr>
          </tbody>
          <tfoot id="col-tfoot" style="display:none;">
            <tr style="background:#18181f;border-top:2px solid #1f1f2e;">
              <td colspan="2" style="color:#f0f0f5;">TOTAL</td>
              <td style="text-align:right;font-size:1rem;color:#f0f0f5;" id="col-t-bruto">0.00</td>
              <td></td>
              <td style="text-align:right;font-size:1rem;color:#4caf7d;" id="col-t-neto">0.00</td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- S2: Recovery metrics -->
    <div id="col-s2" style="display:none;margin-bottom:1.2rem;">
      <div class="card-title" style="margin-bottom:.8rem;">Sección 2 — Métricas de Recovery</div>
      <div class="rec-kpi-grid" id="col-kpis"></div>
    </div>

    <!-- S3: Waterfall -->
    <div id="col-s3" class="card" style="display:none;margin-bottom:1.2rem;">
      <div class="card-title">Sección 3 — Waterfall de Recuperación</div>
      <div id="col-waterfall" style="height:300px;"></div>
    </div>

    <!-- S4: Priority -->
    <div id="col-s4" class="card" style="display:none;">
      <div class="card-title">Sección 4 — Análisis de Prioridad de Cobro</div>
      <div style="overflow-x:auto;">
        <table class="col-table">
          <thead><tr>
            <th>#</th><th>Tipo</th><th>Descripción</th>
            <th>Tiempo ejecución</th>
            <th style="text-align:right;">Recuperable PV (M€)</th>
            <th style="text-align:right;">Cobertura acum.</th>
            <th>Estado</th>
          </tr></thead>
          <tbody id="col-priority"></tbody>
        </table>
      </div>
      <p id="col-note" style="font-size:.75rem;color:#55556a;margin-top:.8rem;">
        Valores presentes descontados al 8% según tiempo medio de ejecución estimado por tipo de activo.
      </p>
    </div>

  </div><!-- /tab-colateral -->

  <!-- ── TAB: DETALLE ── -->
  <div id="tab-detalle" class="section">
    <div class="card">
      <div class="card-title">Detalle Completo del Scoring</div>
      <div style="overflow-x:auto;">
        <table class="det-table">
          <thead><tr>
            <th>Métrica</th><th>Valor</th><th>Puntuación (0–100)</th><th>Peso</th><th>Contribución</th><th>Semáforo</th>
          </tr></thead>
          <tbody id="det-tbody"></tbody>
          <tfoot>
            <tr style="font-weight:800;background:#18181f;">
              <td colspan="3">Score Total</td>
              <td>100%</td>
              <td id="det-total">—</td>
              <td id="det-semaforo">—</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

</div><!-- /main -->

<script>
// ═══════════════════════════════════════════════════════════════
// SCORING MODEL v2
// ═══════════════════════════════════════════════════════════════

// ── S&P Rating + Badge ──
const CIRC = 2 * Math.PI * 72; // ≈ 452.4

function spRating(score) {
  if (score >= 90) return { grade:'AAA', desc:'Calidad máxima' };
  if (score >= 80) return { grade:'AA',  desc:'Muy alta calidad' };
  if (score >= 70) return { grade:'A',   desc:'Alta calidad' };
  if (score >= 60) return { grade:'BBB', desc:'Grado inversión' };
  if (score >= 50) return { grade:'BB',  desc:'Grado especulativo' };
  if (score >= 40) return { grade:'B',   desc:'Especulativo' };
  if (score >= 30) return { grade:'CCC', desc:'Alto riesgo' };
  return { grade:'CC/D', desc:'En default / Impago' };
}

function updateBadge(score, gate) {
  const arc      = document.getElementById('badge-arc');
  const scoreEl  = document.getElementById('badge-score');
  const ratingEl = document.getElementById('badge-rating');
  const descEl   = document.getElementById('badge-rating-desc');
  if (!arc) return;
  const s = Math.max(0, Math.min(100, score));
  const offset = CIRC * (1 - s / 100);
  const color = gate ? '#e05252' : s >= 80 ? '#4caf7d' : s >= 60 ? '#c9a84c' : s >= 40 ? '#e07b39' : '#e05252';
  arc.style.strokeDashoffset = offset;
  arc.style.stroke = color;
  if (scoreEl)  scoreEl.textContent  = Math.round(s);
  if (ratingEl) { const r = spRating(s); ratingEl.textContent = r.grade; ratingEl.style.fill = color; }
  if (descEl)   { const r = spRating(s); descEl.textContent = r.desc; }
}

// ── Spanish number parser ──
function parseSpanishNum(s) {
  if (!s) return null;
  const v = parseFloat(s.replace(/\./g, '').replace(',', '.'));
  return isNaN(v) ? null : v;
}

// ── PDF extraction ──
async function processPDF(input) {
  const file = input.files[0];
  if (!file) return;
  try {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
    const ab   = await file.arrayBuffer();
    const pdf  = await pdfjsLib.getDocument({ data: ab }).promise;
    let text = '';
    for (let p = 1; p <= pdf.numPages; p++) {
      const page  = await pdf.getPage(p);
      const tc    = await page.getTextContent();
      text += tc.items.map(i => i.str).join(' ') + '\n';
    }
    const filled = extractFinancials(text);
    const count  = Object.keys(filled).length;
    let msg = `PDF analizado. Se encontraron ${count} campos:\n`;
    Object.entries(filled).forEach(([k, v]) => { msg += `  • ${k}: ${v}\n`; });
    if (count === 0) msg += '  No se detectaron valores numéricos con los patrones esperados.';
    alert(msg);
  } catch(e) {
    alert('Error al procesar el PDF: ' + e.message);
  }
  input.value = '';
}

function extractFinancials(text) {
  const PATS = [
    { id:'ventas',           re:/(?:ventas?\s*netas?|ingresos?\s*(?:de\s*explotaci[oó]n)?|cifra\s*de\s*negocios?)\s*[:\-]?\s*([\d.,]+)/i },
    { id:'ebitda',           re:/ebitda\s*[:\-]?\s*([\d.,]+)/i },
    { id:'gastos_fin',       re:/gastos?\s*financieros?\s*[:\-]?\s*([\d.,]+)/i },
    { id:'deuda_bruta',      re:/(?:deuda\s*financiera|pasivos?\s*financieros?|pr[eé]stamos?)\s*[:\-]?\s*([\d.,]+)/i },
    { id:'caja',             re:/(?:caja\s*(?:y\s*bancos?)?|efectivo\s*(?:y\s*equivalentes?)?|tesorer[ií]a)\s*[:\-]?\s*([\d.,]+)/i },
    { id:'activo_corriente', re:/activo\s*corriente\s*[:\-]?\s*([\d.,]+)/i },
    { id:'pasivo_corriente', re:/pasivo\s*corriente\s*[:\-]?\s*([\d.,]+)/i },
    { id:'clientes',         re:/(?:clientes|deudores?\s*comerciales?)\s*[:\-]?\s*([\d.,]+)/i },
    { id:'proveedores',      re:/(?:proveedores|acreedores?\s*comerciales?)\s*[:\-]?\s*([\d.,]+)/i },
    { id:'inventario',       re:/(?:existencias|inventario|stocks?)\s*[:\-]?\s*([\d.,]+)/i },
  ];
  const filled = {};
  PATS.forEach(({ id, re }) => {
    const m = text.match(re);
    if (m) {
      const v = parseSpanishNum(m[1]);
      if (v !== null && v > 0) {
        const el = document.getElementById(id);
        if (el) { el.value = v; filled[id] = v; }
      }
    }
  });
  if (Object.keys(filled).length > 0) updateLtvIndicator();
  return filled;
}

// ── Working Capital ──
function calcWC(d) {
  const ventas = Math.max(d.ventas, 0.001);
  const aprov  = d.aprovisionamientos > 0 ? d.aprovisionamientos : ventas * 0.6;
  const fm     = d.activo_corriente - d.pasivo_corriente;
  const fm_pct = fm / ventas * 100;
  const pmc    = d.clientes  / ventas * 365;
  const pmp    = d.proveedores / Math.max(aprov, 0.001) * 365;
  const pma    = d.inventario > 0 ? d.inventario / Math.max(aprov, 0.001) * 365 : null;
  const ciclo  = pma !== null ? pmc + pma - pmp : pmc - pmp;
  const nfm    = d.clientes + (d.inventario || 0) - d.proveedores;
  const nfm_pct = nfm / ventas * 100;
  return { fm, fm_pct, pmc, pmp, pma, ciclo, nfm, nfm_pct, aprov };
}

function renderWorkingCapital(d, wc) {
  const grid = document.getElementById('wc-grid');
  const summ = document.getElementById('wc-summary');
  if (!grid) return;

  const tile = (label, value, sub, cls) =>
    `<div class="ratio-tile ${cls}"><div class="rt-label">${label}</div><div class="rt-value">${value}</div><div class="rt-sub">${sub}</div></div>`;

  const fmCls    = wc.fm >= 0 ? 'verde' : 'rojo';
  const fmPctCls = wc.fm_pct > 10 ? 'verde' : wc.fm_pct > 5 ? 'amarillo' : 'rojo';
  const pmcCls   = wc.pmc < 45 ? 'verde' : wc.pmc < 90 ? 'amarillo' : 'rojo';
  const pmpCls   = wc.pmp > 45 ? 'verde' : wc.pmp > 30 ? 'amarillo' : 'rojo';
  const pmaCls   = wc.pma === null ? '' : wc.pma < 30 ? 'verde' : wc.pma < 60 ? 'amarillo' : 'rojo';
  const cicloCls = wc.ciclo < 30 ? 'verde' : wc.ciclo < 60 ? 'amarillo' : 'rojo';
  const nfmCls   = wc.nfm_pct < 20 ? 'verde' : wc.nfm_pct < 40 ? 'amarillo' : 'rojo';

  grid.innerHTML =
    tile('Fondo de Maniobra', wc.fm.toFixed(1)+' M€', 'Activo corriente − Pasivo corriente', fmCls) +
    tile('FM / Ventas', wc.fm_pct.toFixed(1)+'%', 'Cobertura circulante', fmPctCls) +
    tile('PMC (Días Cobro)', Math.round(wc.pmc)+' días', 'Clientes / Ventas × 365', pmcCls) +
    tile('PMP (Días Pago)', Math.round(wc.pmp)+' días', 'Proveedores / Aprovisionam.', pmpCls) +
    (wc.pma !== null ? tile('PMA (Días Stock)', Math.round(wc.pma)+' días', 'Inventario / Aprovisionam.', pmaCls) : '') +
    tile('Ciclo de Caja', Math.round(wc.ciclo)+' días', 'PMC + PMA − PMP', cicloCls) +
    tile('NFM', wc.nfm.toFixed(1)+' M€', 'Clientes + Stock − Proveedores ('+wc.nfm_pct.toFixed(1)+'% ventas)', nfmCls);

  // Cycle Waterfall chart
  const labels = ['PMC (cobro)', wc.pma !== null ? 'PMA (stock)' : null, 'PMP (pago)', 'Ciclo neto'].filter(Boolean);
  const vals   = [wc.pmc, wc.pma, -wc.pmp, wc.ciclo].filter(v => v !== null);
  const colors = [pmcCls, pmaCls, 'verde', cicloCls].filter((_, i) => [true, wc.pma !== null, true, true][i])
    .map(c => c === 'verde' ? '#4caf7d' : c === 'amarillo' ? '#c9a84c' : c === 'rojo' ? '#e05252' : '#55556a');
  Plotly.react('wc-cycle-chart', [{ type:'bar', x:labels, y:vals, marker:{ color:colors },
    text:vals.map(v => Math.round(v)+' d'), textposition:'outside', textfont:{size:11,color:'#f0f0f5',family:'Inter,sans-serif'} }], {
    paper_bgcolor:'#111118', plot_bgcolor:'#111118', margin:{t:30,b:10,l:50,r:20},
    xaxis:{ showgrid:false, showline:false, tickfont:{size:11, color:'#f0f0f5', family:'Inter,sans-serif'} },
    yaxis:{
      title:{ text:'días', font:{size:10, color:'#55556a'} },
      showgrid:false, zeroline:true, zerolinecolor:'rgba(31,31,46,0.9)',
      showline:false, tickfont:{size:10, color:'#55556a', family:'Inter,sans-serif'}
    },
    font:{ family:'Inter,sans-serif' },
    height:240
  }, { displayModeBar:false, responsive:true });

  // Summary
  summ.innerHTML = `
    <div class="wc-summary-row"><span class="nd-lbl">Fondo de Maniobra (FM)</span><span class="nd-val ${wc.fm>=0?'':''}"><b>${wc.fm.toFixed(2)} M€</b> — ${wc.fm>=0?'Positivo ✓':'Negativo ⚠'}</span></div>
    <div class="wc-summary-row"><span class="nd-lbl">Necesidades de FM (NFM)</span><span class="nd-val"><b>${wc.nfm.toFixed(2)} M€</b> (${wc.nfm_pct.toFixed(1)}% ventas)</span></div>
    <div class="wc-summary-row"><span class="nd-lbl">Superávit / Déficit circulante</span><span class="nd-val" style="color:${wc.fm-wc.nfm>=0?'#4caf7d':'#e05252'};"><b>${(wc.fm-wc.nfm).toFixed(2)} M€</b></span></div>
    <div class="wc-summary-row"><span class="nd-lbl">Aprovisionamientos usados</span><span class="nd-val">${wc.aprov.toFixed(1)} M€ ${d.aprovisionamientos>0?'(declarado)':'(estimado 60% ventas)'}</span></div>`;
}

// ── Historial Crediticio ──
function calcHistorialPenalty(d) {
  let penalty = 0;
  const reasons = [];
  if (d.rai === 'activas')                { penalty -= 15; reasons.push({ txt:'RAI activas', pts:-15 }); }
  if (d.asnef === 'si')                   { penalty -= 5;  reasons.push({ txt:'ASNEF activo', pts:-5 }); }
  if (d.impagos === 'recurrente')         { penalty -= 10; reasons.push({ txt:'Impagos recurrentes', pts:-10 }); }
  if (d.demandas === 'relevante')         { penalty -= 8;  reasons.push({ txt:'Demanda judicial relevante', pts:-8 }); }
  if (d.relacion_bancaria === 'deteriorada') { penalty -= 5; reasons.push({ txt:'Relación bancaria deteriorada', pts:-5 }); }
  if ((d.anios_sin_incidencias || 0) >= 5) { penalty += 3; reasons.push({ txt:'≥5 años sin incidencias', pts:3 }); }
  return { penalty, reasons };
}

function renderCreditHistory(d, histPenalty) {
  const sec = document.getElementById('credit-hist-section');
  const cnt = document.getElementById('credit-hist-content');
  if (!sec || !cnt) return;
  if (histPenalty.reasons.length === 0 && histPenalty.penalty === 0) {
    sec.style.display = 'none'; return;
  }
  sec.style.display = '';
  const rows = histPenalty.reasons.map(r =>
    `<div class="hist-row">
       <span class="hist-lbl">${r.txt}</span>
       <span class="hist-val ${r.pts > 0 ? 'hist-bonus' : 'hist-penalty'}">${r.pts > 0 ? '+' : ''}${r.pts} pts</span>
     </div>`).join('');
  const totalCls = histPenalty.penalty > 0 ? 'hist-bonus' : histPenalty.penalty < 0 ? 'hist-penalty' : 'hist-neutral';
  cnt.innerHTML = rows +
    `<div class="hist-row" style="border-top:2px solid #1f1f2e;margin-top:.3rem;padding-top:.5rem;">
       <span style="font-weight:700;color:#f0f0f5;">Ajuste total sobre score cuantitativo</span>
       <span class="hist-val ${totalCls}" style="font-size:1rem;">${histPenalty.penalty > 0 ? '+' : ''}${histPenalty.penalty} pts</span>
     </div>`;
}

// ── Finalidad covenants ──
function getFinalidadCovenants(finalidad, r) {
  const map = {
    maquinaria:    [
      { name:'Ratio activo neto', value:'≥ 1.2x', desc:'Valor neto activos fijos / Deuda senior. Revisión anual.' },
      { name:'Capex adicional',   value:'Previa aprobación', desc:'Cualquier inversión en activos fijos adicional requiere consentimiento del banco.' }],
    circulante:    [
      { name:'Ciclo de caja máx.', value:'≤ 90 días', desc:'Control del ciclo operativo. Deterioro requiere notificación inmediata.' },
      { name:'Quick ratio mín.',   value:'≥ 1.0x', desc:'Activos líquidos / Pasivo corriente. Revisión trimestral.' }],
    refinanciacion:[
      { name:'Amortización',     value:'100% cumplimiento', desc:'Amortización según calendario pactado sin diferimiento posible.' },
      { name:'Restricción deuda',value:'Sin nueva deuda senior', desc:'Hasta reducción del 50% del principal no se permite nueva deuda financiera.' }],
    ma:            [
      { name:'Leverage post-deal', value:`≤ ${Math.min(+(r.deuda_ebitda<0?2.5:r.deuda_ebitda*1.5+0.5).toFixed(1),6.0)}x DFN/EBITDA`, desc:'Límite combinado post-adquisición. Covenant inicial más restrictivo por 24 meses.' },
      { name:'Integración',        value:'Reporting semestral', desc:'Plan de integración con KPIs de sinergias. Incumplimiento activa consulta previa.' }],
    internacional: [
      { name:'Cobertura FX',      value:'≥ 80% exposición', desc:'Posiciones en divisas cubiertas mediante instrumentos autorizados.' },
      { name:'Ratio exportación', value:'≥ 20% ventas', desc:'Mínimo de ingresos de exportación durante la vida del préstamo.' }],
    idi:           [
      { name:'Propiedad intelectual', value:'Sin cesión', desc:'IP desarrollada con esta financiación no puede cederse sin consentimiento del banco.' },
      { name:'Hitos de proyecto',     value:'Reporting trimestral', desc:'Avance del proyecto I+D reportado con métricas de ejecución acordadas.' }],
    otro:          [
      { name:'Uso de fondos', value:'Conforme escritura', desc:'Los fondos deben destinarse exclusivamente al fin declarado en la póliza de préstamo.' }]
  };
  return map[finalidad] || map.otro;
}

// ── Descripción de la operación ──
function renderDescripcionOperacion(d, r, nd) {
  const el = document.getElementById('nd-finalidad-content');
  if (!el) return;
  const labels = {
    maquinaria:'Adquisición de maquinaria / Capex productivo',
    circulante:'Financiación de capital circulante',
    refinanciacion:'Refinanciación de deuda existente',
    ma:'M&A / Adquisición corporativa',
    internacional:'Expansión internacional',
    idi:'I+D+i / Innovación tecnológica',
    otro:'Propósito general / Otro'
  };
  const descs = {
    maquinaria:'Operación estructurada para financiar activos productivos. Amortización alineada con vida útil del activo. Garantía hipotecaria sobre el bien recomendada.',
    circulante:'Línea de financiación del ciclo operativo. Revisión anual de límite conforme a evolución del ciclo de caja. Factoring como alternativa complementaria.',
    refinanciacion:'Restructuración del pasivo financiero existente. Objetivo: mejora del perfil de vencimientos y coste financiero. Covenant de no nueva deuda hasta reducción del 30% del principal.',
    ma:'Operación de crecimiento inorgánico. Análisis de sinergias y métricas pro-forma requeridas. Periodo de gracia de 12–24 meses para estabilización del perímetro.',
    internacional:'Financiación de expansión en mercados exteriores. Análisis de riesgo país y exposición cambiaria. Seguro de crédito a la exportación recomendado (CESCE).',
    idi:'Operación de innovación con activos intangibles. Milestone-based disbursement recomendado. Due diligence técnica especializada necesaria.',
    otro:'Operación de propósito general. Aplicar covenants estándar. Clarificar uso de fondos en documentación contractual.'
  };
  const f = d.finalidad || 'otro';
  el.innerHTML = `
    <div class="nd-row"><span class="nd-lbl">Finalidad declarada</span><span class="nd-val" style="color:#c9a84c;">${labels[f]||labels.otro}</span></div>
    <div style="background:#18181f;border-radius:8px;padding:.85rem;margin:.7rem 0;font-size:.85rem;color:#f0f0f5;line-height:1.6;">${descs[f]||descs.otro}</div>
    ${d.importe > 0 ? `
    <div class="nd-row"><span class="nd-lbl">Importe solicitado</span><span class="nd-val">${d.importe.toFixed(2)} M€</span></div>
    <div class="nd-row"><span class="nd-lbl">Plazo</span><span class="nd-val">${d.plazo} años</span></div>
    <div class="nd-row"><span class="nd-lbl">Tipo de interés</span><span class="nd-val">${d.tipo_int}%</span></div>
    ` : '<p style="color:#55556a;font-size:.83rem;margin-top:.5rem;">Introduzca importe y plazo en el panel para ver el análisis de viabilidad DSCR.</p>'}`;
}

const PESOS = {
  dscr:          { peso: 25.0, nombre: 'DSCR',             gating: true  },
  deuda_ebitda:  { peso: 20.0, nombre: 'DFN / EBITDA',     gating: true  },
  llcr:          { peso: 15.0, nombre: 'LLCR',             gating: false },
  ebitda_margin: { peso: 10.0, nombre: 'Margen EBITDA',    gating: false },
  ltv:           { peso: 10.0, nombre: 'LTV Colateral',    gating: false },
  ffo_dfn:       { peso: 10.0, nombre: 'FFO / DFN',        gating: false },
  dias_cobro:    { peso:  5.0, nombre: 'Días de Cobro',    gating: false },
  equipo:        { peso:  1.25,nombre: 'Equipo Directivo', gating: false },
  concentracion: { peso:  1.25,nombre: 'Diversif. Clientes',gating: false },
  antiguedad:    { peso:  1.25,nombre: 'Antigüedad Negocio',gating: false },
  ciclicidad:    { peso:  1.25,nombre: 'Estabilidad Sector',gating: false },
};

// Linear interpolation between breakpoints [[v0,p0],[v1,p1],...]
function linScore(v, pts) {
  if (v <= pts[0][0]) return pts[0][1];
  if (v >= pts[pts.length-1][0]) return pts[pts.length-1][1];
  for (let i = 0; i < pts.length-1; i++) {
    const [v0,p0] = pts[i], [v1,p1] = pts[i+1];
    if (v >= v0 && v <= v1) return Math.round(p0 + (p1-p0)*(v-v0)/(v1-v0));
  }
  return 0;
}

// LTV max by collateral type (shared across calc functions)
const LTV_MAX = { inmueble:60, maquinaria:40, cuentas_cobrar:70, stock:50, mixto:55, ninguno:null };

const SCORE_FNS = {
  // DSCR: Rojo<1.0x(0-19), Naranja 1.0-1.2x(20-49), Amarillo 1.2-1.5x(50-79), Verde>1.5x(80-100)
  dscr:          v => linScore(v, [[0,0],[1.0,19],[1.2,49],[1.5,80],[2.5,100]]),
  deuda_ebitda:  v => v < 0 ? 100 : linScore(v, [[0,100],[2.5,80],[4.0,40],[7.0,0]]),
  // LLCR: Rojo<1.0x(0-19), Naranja 1.0-1.2x(20-49), Amarillo 1.2-1.4x(50-79), Verde>1.4x(80-100)
  llcr:          v => linScore(v, [[0,0],[1.0,19],[1.2,49],[1.4,80],[2.0,100]]),
  ebitda_margin: v => linScore(v, [[-5,0],[0,10],[8,40],[15,80],[25,100]]),
  // LTV: Verde<50%(80-100), Amarillo 50-60%(50-79), Naranja 60-70%(20-49), Rojo>70%(0-19)
  ltv:           v => v === null ? 55 : linScore(v, [[0,100],[50,80],[60,50],[70,20],[100,0]]),
  ffo_dfn:       v => linScore(v, [[0,10],[15,40],[20,80],[35,100]]),
  dias_cobro:    v => linScore(v, [[0,100],[45,80],[90,40],[180,0]]),
  equipo:        v => ({1:0,2:25,3:50,4:75,5:100})[Math.round(v)] || 0,
  concentracion: v => ({1:0,2:25,3:50,4:75,5:100})[Math.round(v)] || 0,
  antiguedad:    v => ({1:0,2:25,3:50,4:75,5:100})[Math.round(v)] || 0,
  ciclicidad:    v => ({1:0,2:25,3:50,4:75,5:100})[Math.round(v)] || 0,
};

// Sector benchmarks: {metric: {p25, med, p75}}
// metrics: em=EBITDA margin%, dn=DFN/EBITDA, ds=DSCR, dc=Días cobro
const SECT = {
  metalurgia:   { n:'Metalurgia / Fab. metal',    em:{p25:7,  med:11, p75:16}, dn:{p25:1.5,med:2.8,p75:4.2}, ds:{p25:1.0,med:1.4,p75:1.9}, dc:{p25:45, med:65, p75:90 } },
  quimica:      { n:'Química / Plásticos',         em:{p25:9,  med:14, p75:20}, dn:{p25:1.2,med:2.3,p75:3.8}, ds:{p25:1.1,med:1.5,p75:2.1}, dc:{p25:40, med:58, p75:80 } },
  alimentacion: { n:'Alimentación / Bebidas',      em:{p25:8,  med:12, p75:18}, dn:{p25:1.0,med:2.0,p75:3.5}, ds:{p25:1.2,med:1.6,p75:2.3}, dc:{p25:30, med:45, p75:65 } },
  automocion:   { n:'Automoción / Componentes',    em:{p25:6,  med:10, p75:15}, dn:{p25:1.8,med:3.0,p75:4.5}, ds:{p25:0.9,med:1.3,p75:1.8}, dc:{p25:50, med:72, p75:100} },
  papel_carton: { n:'Papel / Cartón',              em:{p25:10, med:15, p75:21}, dn:{p25:1.3,med:2.5,p75:4.0}, ds:{p25:1.1,med:1.5,p75:2.0}, dc:{p25:35, med:55, p75:75 } },
  construccion: { n:'Construcción industrial',     em:{p25:5,  med:9,  p75:14}, dn:{p25:2.0,med:3.2,p75:5.0}, ds:{p25:0.8,med:1.2,p75:1.7}, dc:{p25:60, med:85, p75:120} },
  energia:      { n:'Energía / Renovables',        em:{p25:30, med:45, p75:60}, dn:{p25:3.0,med:4.5,p75:6.5}, ds:{p25:1.3,med:1.7,p75:2.2}, dc:{p25:25, med:40, p75:60 } },
  logistica:    { n:'Logística / Transporte',      em:{p25:6,  med:10, p75:15}, dn:{p25:1.5,med:2.7,p75:4.2}, ds:{p25:1.0,med:1.4,p75:1.9}, dc:{p25:30, med:50, p75:70 } },
};

// ═══════════════════════════════════════════════════════════════
// RATIO CALCULATION
// ═══════════════════════════════════════════════════════════════
function calcRatios(d) {
  const ebitda   = d.ebitda;
  const ventas   = Math.max(d.ventas, 0.001);
  const dfn      = d.deuda_bruta - d.caja;
  const ebitda_margin = ebitda / ventas * 100;
  const deuda_ebitda  = ebitda > 0 ? dfn / ebitda : (dfn <= 0 ? -1 : 99);
  const dias_cobro    = d.clientes / ventas * 365;
  const dias_pago     = d.proveedores / ventas * 365;
  const liquidez      = d.pasivo_corriente > 0 ? d.activo_corriente / d.pasivo_corriente : 99;

  // CFADS = EBITDA - impuestos pagados - capex mantenimiento
  const cfads = ebitda - d.imp_pagado - (d.capex_mant || 0);

  // Debt service = gastos financieros + amortización (DFN / vida_media)
  const vida_media = Math.max(d.vida_media || 5, 0.5);
  const amort      = Math.max(dfn, 0) / vida_media;
  const debt_svc   = d.gastos_fin + amort;
  const dscr       = debt_svc > 0 ? cfads / debt_svc : (cfads > 0 ? 99 : 0);

  // LLCR: PV of CFADS over loan life / loan balance
  const loanBase = d.importe > 0 ? d.importe : Math.max(dfn, 0.001);
  const rate     = Math.max((d.tipo_int || 6) / 100, 0.0001);
  const n_loan   = d.importe > 0 ? Math.max(d.plazo || 5, 1) : Math.max(vida_media, 1);
  const pvFactor = (1 - Math.pow(1 + rate, -n_loan)) / rate;
  const llcr     = loanBase > 0 ? (cfads * pvFactor) / loanBase : 99;

  // LTV — use loanBase (importe or DFN) so colateral always feeds into scoring
  let ltv = null;
  if (d.colateral > 0) {
    ltv = (loanBase / d.colateral) * 100;
  }

  // FFO / DFN %
  const ffo     = ebitda - d.gastos_fin - d.imp_pagado;
  const ffo_dfn = dfn > 0 ? (ffo / dfn * 100) : (ffo > 0 ? 100 : 10);

  return {
    ebitda, ventas, dfn, ebitda_margin, deuda_ebitda,
    dias_cobro, dias_pago, liquidez, cfads, debt_svc,
    dscr, llcr, ltv, ffo, ffo_dfn, amort, vida_media, loanBase, n_loan, rate,
    tipo_col: d.tipo_col, colateral: d.colateral,
    importe: d.importe, plazo: d.plazo, tipo_int: d.tipo_int,
    gastos_fin: d.gastos_fin
  };
}

function calcScores(r) {
  const res = {};
  for (const [key, cfg] of Object.entries(PESOS)) {
    const val = r[key] !== undefined ? r[key] : null;
    const sc  = SCORE_FNS[key](val);
    const contrib = sc * cfg.peso / 100;
    const color   = sc >= 80 ? 'verde' : sc >= 50 ? 'amarillo' : sc >= 20 ? 'naranja' : 'rojo';
    res[key] = { valor: val, puntuacion: sc, peso: cfg.peso, contrib, color,
                 nombre: cfg.nombre, gating: cfg.gating };
  }
  return res;
}

function totalScore(res) {
  return Object.values(res).reduce((s, v) => s + v.contrib, 0);
}

function checkGating(res) {
  // DSCR < 1.0x → score 0-19 → auto-reject (principal gate)
  const dscrFails = res.dscr.puntuacion < 20;
  // DFN/EBITDA > 4.0x → score < 40 → secondary gate
  const dfnFails  = res.deuda_ebitda.puntuacion < 40;
  if (dscrFails && dfnFails) return 'DSCR < 1.0x y DFN/EBITDA > 4.0x simultáneamente: doble incumplimiento de métricas de exclusión. Operación rechazada automáticamente independientemente del score total.';
  if (dscrFails) return 'DSCR < 1.0x: el CFADS no cubre el servicio de la deuda. Umbral mínimo absoluto incumplido. Operación rechazada automáticamente.';
  if (dfnFails)  return 'DFN/EBITDA > 4.0x: nivel de apalancamiento fuera del umbral de mercado para deuda senior. Operación rechazada automáticamente.';
  return null;
}

// ═══════════════════════════════════════════════════════════════
// NUEVA DEUDA ANALYSIS
// ═══════════════════════════════════════════════════════════════
function calcNuevaDeuda(d, r) {
  if (d.importe <= 0) return null;
  const rate   = Math.max(d.tipo_int / 100, 0.0001);
  const n      = Math.max(d.plazo, 1);
  const newDS  = r.importe * rate + r.importe / n;           // simplified DS
  const combDS = r.debt_svc + newDS;
  const combDSCR = combDS > 0 ? r.cfads / combDS : 99;
  const fits     = combDSCR >= 1.25;

  // Max financeable at 1.25x DSCR
  const headroom  = r.cfads / 1.25 - r.debt_svc;
  const maxNew    = headroom > 0 ? Math.max(headroom / (rate + 1/n), 0) : 0;

  // LTV check
  const ltvMaxPct = LTV_MAX[d.tipo_col] || null;
  const ltvOk     = r.ltv !== null && ltvMaxPct !== null ? r.ltv <= ltvMaxPct : true;

  return { newDS, combDSCR, fits, maxNew, ltvOk, ltvMaxPct };
}

// ═══════════════════════════════════════════════════════════════
// READ INPUTS
// ═══════════════════════════════════════════════════════════════
function readInputs() {
  const g  = id => parseFloat(document.getElementById(id).value) || 0;
  const gs = id => { const el = document.getElementById(id); return el ? el.value : ''; };
  const invTotal = _colRows.reduce((s,r) => s + (parseFloat(r.bruto)||0), 0);
  return {
    ventas: g('ventas'), ebitda: g('ebitda'), gastos_fin: g('gastos_fin'),
    imp_pagado: g('imp_pagado'), capex_mant: g('capex_mant'),
    deuda_bruta: g('deuda_bruta'), caja: g('caja'),
    activo_corriente: g('activo_corriente'), pasivo_corriente: g('pasivo_corriente'),
    clientes: g('clientes'), proveedores: g('proveedores'), vida_media: g('vida_media'),
    inventario: g('inventario'), aprovisionamientos: g('aprovisionamientos'),
    importe: g('importe'), plazo: g('plazo'), tipo_int: g('tipo_int'),
    colateral: invTotal > 0 ? invTotal : g('colateral'),
    tipo_col: gs('tipo_col'),
    finalidad: gs('finalidad') || 'maquinaria',
    rai: gs('rai') || 'ninguna', asnef: gs('asnef') || 'no',
    impagos: gs('impagos') || 'ninguno', demandas: gs('demandas') || 'ninguna',
    relacion_bancaria: gs('relacion_bancaria') || 'buena',
    anios_sin_incidencias: g('anios_sin_incidencias'),
    equipo: parseInt(gs('equipo')), concentracion: parseInt(gs('concentracion')),
    antiguedad: parseInt(gs('antiguedad')), ciclicidad: parseInt(gs('ciclicidad')),
    sector_comp: gs('sector_comp'),
  };
}

// ═══════════════════════════════════════════════════════════════
// RENDER
// ═══════════════════════════════════════════════════════════════
let _currentData = null;

// ── Specific improvement text for ANALIZAR MÁS ──
function buildImprovementText(r, res) {
  // For each key metric, define: nextTarget if below verde, direction
  const checks = [
    {
      key: 'dscr', val: r.dscr, label: 'DSCR',
      thresholds: [{v:1.0,lbl:'1.0x (naranja)'},{v:1.2,lbl:'1.2x (amarillo)'},{v:1.5,lbl:'1.5x (verde)'}],
      fmt: v => v.toFixed(2)+'x', dir: 'higher'
    },
    {
      key: 'llcr', val: r.llcr, label: 'LLCR',
      thresholds: [{v:1.2,lbl:'1.2x (amarillo)'},{v:1.4,lbl:'1.4x (verde)'}],
      fmt: v => v.toFixed(2)+'x', dir: 'higher'
    },
    {
      key: 'deuda_ebitda', val: r.deuda_ebitda < 0 ? 0 : r.deuda_ebitda, label: 'DFN/EBITDA',
      thresholds: [{v:4.0,lbl:'4.0x'},{v:2.5,lbl:'2.5x (verde)'}],
      fmt: v => v.toFixed(2)+'x', dir: 'lower'
    },
    {
      key: 'ebitda_margin', val: r.ebitda_margin, label: 'Margen EBITDA',
      thresholds: [{v:8,lbl:'8%'},{v:15,lbl:'15% (verde)'}],
      fmt: v => v.toFixed(1)+'%', dir: 'higher'
    },
    {
      key: 'ffo_dfn', val: r.ffo_dfn, label: 'FFO/DFN',
      thresholds: [{v:15,lbl:'15%'},{v:20,lbl:'20% (verde)'}],
      fmt: v => v.toFixed(1)+'%', dir: 'higher'
    },
  ];

  const improvements = [];
  for (const c of checks) {
    if (res[c.key].puntuacion >= 80) continue; // ya verde, skip
    let target = null;
    if (c.dir === 'higher') {
      for (const t of c.thresholds) { if (c.val < t.v) { target = t; break; } }
    } else {
      for (const t of c.thresholds) { if (c.val > t.v) { target = t; break; } }
    }
    if (!target) continue;
    const pct = c.dir === 'higher'
      ? Math.abs((target.v - c.val) / Math.max(Math.abs(c.val), 0.001) * 100).toFixed(0)
      : Math.abs((c.val - target.v) / Math.max(Math.abs(target.v), 0.001) * 100).toFixed(0);
    const arrow = c.dir === 'higher' ? '↑' : '↓';
    improvements.push(`${c.label} actual ${c.fmt(c.val)} — necesita ${c.dir === 'higher' ? 'subir' : 'bajar'} a ${target.lbl} (${arrow}${pct}%)`);
    if (improvements.length >= 3) break;
  }

  return improvements.length > 0
    ? improvements.join('. ') + '.'
    : 'Revisar ratios de cobertura y apalancamiento.';
}

// ── Sidebar LTV indicator ──
function updateLtvIndicator() {
  const importe  = parseFloat(document.getElementById('importe').value) || 0;
  const colateral= parseFloat(document.getElementById('colateral').value) || 0;
  const tipocol  = document.getElementById('tipo_col').value;
  const ind      = document.getElementById('ltv-indicator');
  if (!ind) return;
  if (importe <= 0 || colateral <= 0 || tipocol === 'ninguno') {
    ind.className = 'ltv-indicator'; ind.textContent = ''; return;
  }
  const ltvCalc = (importe / colateral * 100).toFixed(1);
  const ltvMax  = LTV_MAX[tipocol];
  if (!ltvMax) { ind.className = 'ltv-indicator'; return; }
  const ok = parseFloat(ltvCalc) <= ltvMax;
  ind.className = 'ltv-indicator ' + (ok ? 'ltv-ok' : 'ltv-bad');
  ind.textContent = `LTV ${ltvCalc}% ${ok ? '✓' : '✗'} (máx. ${ltvMax}%)`;
}

function update() {
  const d = readInputs();
  const r = calcRatios(d);

  r.equipo = d.equipo; r.concentracion = d.concentracion;
  r.antiguedad = d.antiguedad; r.ciclicidad = d.ciclicidad;

  const res       = calcScores(r);
  const baseScore = Math.round(totalScore(res));
  const histPenalty = calcHistorialPenalty(d);
  const score     = Math.max(0, Math.min(100, baseScore + histPenalty.penalty));
  const gate      = checkGating(res);
  const nd        = calcNuevaDeuda(d, r);
  const wc        = calcWC(d);

  _currentData = { d, r, res, score, baseScore, gate, nd, wc, histPenalty };

  renderScoring(d, r, res, score, baseScore, gate, histPenalty);
  renderWorkingCapital(d, wc);
  renderNuevaDeuda(d, r, nd);
  renderComparables(d, r);
  renderCovenants(r, res, score, d);
  renderDetalle(res, score, baseScore, histPenalty);
  recalcColateral();
}

// ── SCORING TAB ──
function renderScoring(d, r, res, score, baseScore, gate, histPenalty) {
  // KPIs
  setText('kpi-ebitda',  r.ebitda.toFixed(1) + ' M€');
  setText('kpi-margin',  r.ebitda_margin.toFixed(1) + '%');
  setText('kpi-dfn',     r.dfn.toFixed(1) + ' M€');
  setText('kpi-le',      (r.deuda_ebitda < 0 ? 'Caja neta' : r.deuda_ebitda.toFixed(2) + 'x'));
  setText('kpi-dscr',    r.dscr.toFixed(2) + 'x');
  setText('kpi-llcr',    r.llcr.toFixed(2) + 'x');

  // Gating banner
  const banner = document.getElementById('gating-banner');
  if (gate) {
    banner.classList.add('visible');
    setText('gating-text', gate);
  } else {
    banner.classList.remove('visible');
  }

  // SVG Badge
  updateBadge(score, gate);

  // Stacked bar
  const labels = Object.values(res).map(v => v.nombre);
  const contribs = Object.values(res).map(v => +v.contrib.toFixed(2));
  const colors   = Object.values(res).map(v =>
    v.color === 'verde' ? '#4caf7d' : v.color === 'amarillo' ? '#c9a84c' :
    v.color === 'naranja' ? '#e07b39' : '#e05252');
  Plotly.react('bar-chart', [{
    type:'bar', orientation:'h',
    x: contribs, y: labels,
    marker: { color: colors },
    text: contribs.map(v => v.toFixed(1)+' pts'),
    textposition: 'outside',
    textfont: { size: 11, color: '#f0f0f5', family: 'Inter,sans-serif' },
    hovertemplate: '%{y}: %{x:.1f} pts<extra></extra>'
  }], {
    margin:{t:8,b:8,l:155,r:65},
    paper_bgcolor:'#111118', plot_bgcolor:'#111118',
    xaxis:{
      range:[0, Math.max(...contribs)*1.45],
      showgrid:false, zeroline:false, showline:false,
      ticks:'', showticklabels:false
    },
    yaxis:{
      automargin:true,
      tickfont:{size:11, color:'#f0f0f5', family:'Inter,sans-serif'},
      showgrid:false, zeroline:false, showline:false
    },
    font:{ family:'Inter,sans-serif', color:'#f0f0f5' },
    height:240
  }, { displayModeBar:false, responsive:true });

  // Recommendation
  const recBanner = document.getElementById('rec-banner');
  recBanner.className = 'rec-banner ';
  let icon, decision, text;
  if (gate) {
    recBanner.className += 'rojo';
    icon = '⛔'; decision = 'RECHAZAR';
    text = 'La operación incumple una métrica de exclusión (gating). Independientemente del score total, la política de riesgo impide la aprobación. Requiere reestructuración financiera previa o garantías adicionales extraordinarias.';
  } else if (score >= 70) {
    recBanner.className += 'verde';
    icon = '✅'; decision = 'OPERAR';
    text = `Score ${score}/100 — Perfil de riesgo sólido. Se recomienda avanzar con la operación bajo condiciones estándar. Establecer covenants de seguimiento trimestral. Posible pricing competitivo por encima de DSCR ${r.dscr.toFixed(2)}x.`;
  } else if (score >= 40) {
    recBanner.className += 'amarillo';
    icon = '⚠️'; decision = 'ANALIZAR MÁS';
    text = `Score ${score}/100 — Perfil de riesgo moderado con alertas. ${buildImprovementText(r, res)} Ampliar due diligence y exigir covenants reforzados.`;
  } else {
    recBanner.className += 'rojo';
    icon = '❌'; decision = 'RECHAZAR';
    text = `Score ${score}/100 — Perfil de riesgo elevado. Los ratios de cobertura y/o apalancamiento no alcanzan umbrales mínimos de mercado. Rechazar en las condiciones actuales. Posible revisión si el cliente presenta plan de mejora creíble con sponsor financiero.`;
  }
  setText('rec-icon', icon);
  setText('rec-decision', decision);
  setText('rec-text', text);

  // Credit history
  renderCreditHistory(d, histPenalty);

  // Ratio tiles
  const fmtMap = {
    dscr:          { fmt: v => v.toFixed(2)+'x', label:'DSCR' },
    deuda_ebitda:  { fmt: v => v < 0 ? 'Caja neta' : v.toFixed(2)+'x', label:'DFN / EBITDA' },
    llcr:          { fmt: v => v.toFixed(2)+'x', label:'LLCR' },
    ebitda_margin: { fmt: v => v.toFixed(1)+'%', label:'Margen EBITDA' },
    ltv:           { fmt: v => v === null ? 'N/A' : v.toFixed(1)+'%', label:'LTV Colateral' },
    ffo_dfn:       { fmt: v => v.toFixed(1)+'%', label:'FFO / DFN' },
    dias_cobro:    { fmt: v => Math.round(v)+' días', label:'Días Cobro' },
    equipo:        { fmt: v => v+' / 5', label:'Equipo' },
    concentracion: { fmt: v => v+' / 5', label:'Diversif. Clientes' },
    antiguedad:    { fmt: v => v+' / 5', label:'Antigüedad' },
    ciclicidad:    { fmt: v => v+' / 5', label:'Estabilidad' },
  };
  const subMap = {
    dscr:'cobertura deuda', deuda_ebitda:'apalancamiento', llcr:'loan life coverage',
    ebitda_margin:'sobre ventas', ltv:'loan-to-value', ffo_dfn:'sobre DFN',
    dias_cobro:'DSO cobro', equipo:'cualitativo', concentracion:'cualitativo',
    antiguedad:'cualitativo', ciclicidad:'cualitativo',
  };
  let tilesHtml = '';
  for (const [key, m] of Object.entries(fmtMap)) {
    const rv = res[key];
    const gBadge = rv.gating ? '<span class="gating-badge">GATE</span>' : '';
    const valStr = fmtMap[key].fmt(rv.valor);
    tilesHtml += `
      <div class="ratio-tile ${rv.color}">
        <div class="rt-label">${m.label}${gBadge}</div>
        <div class="rt-value">${valStr}</div>
        <div class="rt-sub">${subMap[key]}</div>
        <span class="rt-score">${rv.puntuacion} pts × ${rv.peso}%</span>
      </div>`;
  }
  document.getElementById('ratio-grid').innerHTML = tilesHtml;

  // Radar
  const names = Object.values(res).map(v => v.nombre);
  const scores = Object.values(res).map(v => v.puntuacion);
  Plotly.react('radar-chart', [{
    type:'scatterpolar', mode:'lines+markers',
    r: [...scores, scores[0]], theta: [...names, names[0]],
    fill:'toself', fillcolor:'rgba(201,168,76,0.08)',
    line:{ color:'#c9a84c', width:1.5 },
    marker:{ color:'#c9a84c', size:3, opacity:0.6 }
  }], {
    polar:{
      radialaxis:{
        range:[0,100],
        tickfont:{size:8, color:'#55556a', family:'Inter,sans-serif'},
        gridcolor:'rgba(31,31,46,0.6)',
        showline:false,
        tickvals:[20,40,60,80,100]
      },
      angularaxis:{
        showgrid:false,
        showline:false,
        tickfont:{size:9, color:'#c9a84c', family:'Inter,sans-serif'}
      },
      bgcolor:'#111118'
    },
    paper_bgcolor:'#111118',
    margin:{t:35,b:35,l:65,r:65},
    height:320,
    font:{ family:'Inter,sans-serif', color:'#f0f0f5' }
  }, { displayModeBar:false, responsive:true });

  // Top 3 risks
  const sorted = Object.entries(res)
    .map(([k,v]) => ({ ...v, key:k, perdida: v.peso - v.contrib }))
    .sort((a,b) => b.perdida - a.perdida)
    .slice(0, 3);

  const riskHtml = sorted.map((f, i) => {
    const valStr = fmtMap[f.key] ? fmtMap[f.key].fmt(f.valor) : f.valor;
    return `
      <div class="risk-card">
        <div class="r-rank">#${i+1} Factor de Riesgo</div>
        <div class="r-name">${f.nombre}${f.gating ? ' <span class="gating-badge">GATE</span>' : ''}</div>
        <div class="r-value">Valor: ${valStr} — Score: ${f.puntuacion}/100</div>
        <div class="r-impact">Impacto: −${f.perdida.toFixed(1)} pts de contribución potencial</div>
      </div>`;
  }).join('');
  document.getElementById('risk-grid').innerHTML = riskHtml;
}

// ── NUEVA DEUDA TAB ──
function renderNuevaDeuda(d, r, nd) {
  renderDescripcionOperacion(d, r, nd);
  const ndC   = document.getElementById('nd-content');
  const ndCap = document.getElementById('nd-capacity');
  const ndLtv = document.getElementById('nd-ltv');

  // ── Capacidad de endeudamiento — siempre visible ──
  const rate_cap = Math.max((d.tipo_int || 6) / 100, 0.0001);
  const n_cap    = Math.max(d.plazo || 5, 1);
  const maxNew   = r.cfads / 1.25 > r.debt_svc
    ? Math.max((r.cfads / 1.25 - r.debt_svc) / (rate_cap + 1/n_cap), 0)
    : 0;
  const headroomPct = r.debt_svc > 0
    ? ((r.cfads / r.debt_svc - 1.25) / 1.25 * 100).toFixed(1)
    : '∞';

  ndCap.innerHTML = `
    <div class="nd-row"><span class="nd-lbl">CFADS disponible</span><span class="nd-val">${r.cfads.toFixed(2)} M€</span></div>
    <div class="nd-row"><span class="nd-lbl">Servicio deuda actual / año</span><span class="nd-val">${r.debt_svc.toFixed(2)} M€</span></div>
    <div class="nd-row"><span class="nd-lbl">DSCR actual</span><span class="nd-val">${r.dscr.toFixed(2)}x</span></div>
    <div class="nd-row"><span class="nd-lbl">Importe máx. financiable (DSCR = 1.25x)</span>
      <span class="nd-val" style="color:${maxNew > 0 ? '#4caf7d' : '#e05252'};font-size:1rem;">
        ${maxNew > 0 ? maxNew.toFixed(2)+' M€' : 'Capacidad agotada'}
      </span>
    </div>
    <div class="nd-row"><span class="nd-lbl">Headroom sobre 1.25x DSCR</span><span class="nd-val">${headroomPct}%</span></div>
    <div class="nd-row"><span class="nd-lbl">Tipo int. referencia / Plazo</span><span class="nd-val">${d.tipo_int}% / ${d.plazo} años</span></div>`;

  // ── Análisis de operación nueva — sólo si importe > 0 ──
  if (!nd) {
    ndC.innerHTML = `
      <p style="color:#55556a;font-size:.85rem;margin-bottom:.8rem;">
        Introduce el importe, plazo y tipo de interés en el panel lateral para analizar la operación concreta.
      </p>
      <div class="nd-row"><span class="nd-lbl">Capacidad adicional estimada</span>
        <span class="nd-val" style="color:${maxNew>0?'#4caf7d':'#e05252'};">
          ${maxNew > 0 ? '≈ '+maxNew.toFixed(2)+' M€ disponibles' : 'Sin capacidad adicional'}
        </span>
      </div>`;
  } else {
    const statusClass = nd.fits ? 'nd-ok' : nd.combDSCR >= 1.0 ? 'nd-warn' : 'nd-bad';
    const statusText  = nd.fits ? '✓ VIABLE (DSCR ≥ 1.25x)' : nd.combDSCR >= 1.0 ? '⚠ AJUSTADO (1.0x–1.25x)' : '✗ NO VIABLE (DSCR < 1.0x)';
    const margin      = maxNew - d.importe;
    ndC.innerHTML = `
      <div class="nd-row"><span class="nd-lbl">Importe solicitado</span><span class="nd-val">${d.importe.toFixed(2)} M€</span></div>
      <div class="nd-row"><span class="nd-lbl">Servicio deuda nueva / año</span><span class="nd-val">${nd.newDS.toFixed(2)} M€</span></div>
      <div class="nd-row"><span class="nd-lbl">DSCR combinado (nueva + existente)</span><span class="nd-val">${nd.combDSCR.toFixed(2)}x</span></div>
      <div class="nd-row"><span class="nd-lbl">Margen vs. importe máx. financiable</span>
        <span class="nd-val" style="color:${margin>=0?'#4caf7d':'#e05252'};">
          ${margin >= 0 ? '+'+margin.toFixed(2)+' M€' : margin.toFixed(2)+' M€'}
        </span>
      </div>
      <div class="nd-row"><span class="nd-lbl">Resultado</span>
        <span class="nd-val"><span class="nd-status ${statusClass}">${statusText}</span></span>
      </div>`;
  }

  // ── LTV ──
  if (d.colateral > 0 && d.importe > 0 && r.ltv !== null) {
    const ltvMax    = LTV_MAX[d.tipo_col] || null;
    const ltvStatus = ltvMax ? (r.ltv <= ltvMax ? 'nd-ok' : 'nd-bad') : 'nd-warn';
    const ltvTxt    = ltvMax
      ? (r.ltv <= ltvMax ? `✓ Dentro del límite (máx. ${ltvMax}%)` : `✗ Supera límite ${ltvMax}% para ${d.tipo_col}`)
      : 'Sin límite definido';
    ndLtv.innerHTML = `
      <div class="nd-row"><span class="nd-lbl">Tipo de colateral</span><span class="nd-val">${d.tipo_col}</span></div>
      <div class="nd-row"><span class="nd-lbl">Valor colateral</span><span class="nd-val">${d.colateral.toFixed(2)} M€</span></div>
      <div class="nd-row"><span class="nd-lbl">Importe solicitado</span><span class="nd-val">${d.importe.toFixed(2)} M€</span></div>
      <div class="nd-row"><span class="nd-lbl">LTV calculado</span><span class="nd-val">${r.ltv.toFixed(1)}%</span></div>
      <div class="nd-row"><span class="nd-lbl">Resultado LTV</span>
        <span class="nd-val"><span class="nd-status ${ltvStatus}">${ltvTxt}</span></span>
      </div>`;
  } else {
    ndLtv.innerHTML = '<p style="color:#55556a;font-size:.85rem;">Introduce importe y valor del colateral para ver el análisis LTV.</p>';
  }
}

// ── COMPARABLES TAB ──
function renderComparables(d, r) {
  const sect = SECT[d.sector_comp] || SECT['metalurgia'];
  setText('sect-name', sect.n);

  const metrics = [
    { key:'em',  label:'Margen EBITDA (%)', val: r.ebitda_margin, fmt: v => v.toFixed(1)+'%', higher:'better' },
    { key:'dn',  label:'DFN / EBITDA (x)',  val: r.deuda_ebitda < 0 ? 0 : r.deuda_ebitda, fmt: v => v.toFixed(2)+'x', higher:'worse' },
    { key:'ds',  label:'DSCR (x)',           val: r.dscr, fmt: v => v.toFixed(2)+'x', higher:'better' },
    { key:'dc',  label:'Días Cobro',         val: r.dias_cobro, fmt: v => Math.round(v)+' d', higher:'worse' },
  ];

  let rows = '';
  metrics.forEach(m => {
    const s = sect[m.key];
    const v = m.val;
    // Position
    let pos, posCls;
    if (m.higher === 'better') {
      if (v >= s.p75)      { pos='Top 25%'; posCls='pos-good'; }
      else if (v >= s.med) { pos='25–50%';  posCls='pos-mid';  }
      else if (v >= s.p25) { pos='50–75%';  posCls='pos-mid';  }
      else                 { pos='Bottom 25%'; posCls='pos-bad'; }
    } else {
      if (v <= s.p25)      { pos='Top 25%'; posCls='pos-good'; }
      else if (v <= s.med) { pos='25–50%';  posCls='pos-mid';  }
      else if (v <= s.p75) { pos='50–75%';  posCls='pos-mid';  }
      else                 { pos='Bottom 25%'; posCls='pos-bad'; }
    }
    rows += `<tr class="company-row">
      <td>${m.label}</td>
      <td>${m.fmt(s.p25)}</td>
      <td>${m.fmt(s.med)}</td>
      <td>${m.fmt(s.p75)}</td>
      <td style="font-weight:800;">${m.fmt(v)}</td>
      <td class="${posCls}">${pos}</td>
    </tr>`;
  });
  document.getElementById('sect-tbody').innerHTML = rows;

  // Waterfall chart comparing metrics
  const categories = metrics.map(m => m.label);
  const companyVals = metrics.map(m => m.val);
  const medVals     = metrics.map(m => sect[m.key].med);

  Plotly.react('sect-chart', [
    {
      type:'bar', name:'Esta empresa',
      x: categories, y: companyVals,
      marker:{ color:'#c9a84c' },
      text: companyVals.map((v,i) => metrics[i].fmt(v)),
      textposition:'outside', textfont:{size:10,color:'#f0f0f5',family:'Inter,sans-serif'}
    },
    {
      type:'bar', name:'Mediana sector',
      x: categories, y: medVals,
      marker:{ color:'#55556a' },
      text: medVals.map((v,i) => metrics[i].fmt(v)),
      textposition:'outside', textfont:{size:10,color:'#f0f0f5',family:'Inter,sans-serif'}
    }
  ], {
    barmode:'group',
    paper_bgcolor:'#111118', plot_bgcolor:'#111118',
    legend:{
      orientation:'h', y:1.22,
      font:{size:11, color:'#f0f0f5', family:'Inter,sans-serif'},
      bgcolor:'rgba(0,0,0,0)', borderwidth:0
    },
    margin:{ t:48,b:10,l:50,r:20 },
    height:300,
    xaxis:{ showgrid:false, showline:false, tickfont:{size:11, color:'#f0f0f5', family:'Inter,sans-serif'} },
    yaxis:{ showgrid:false, zeroline:false, showline:false, tickfont:{size:10, color:'#55556a', family:'Inter,sans-serif'} },
    font:{ family:'Inter,sans-serif', color:'#f0f0f5' }
  }, { displayModeBar:false, responsive:true });
}

// ── COVENANTS TAB ──
function renderCovenants(r, res, score, d) {
  // Finalidad-specific covenants
  const finCovs = getFinalidadCovenants(d ? d.finalidad : 'otro', r);
  const finGrid = document.getElementById('cov-finalidad-grid');
  if (finGrid) {
    finGrid.innerHTML = finCovs.map(c =>
      `<div class="cov-card" style="border-left-color:#c9a84c;">
         <div class="cov-name">${c.name}</div>
         <div class="cov-value">${c.value}</div>
         <div class="cov-desc">${c.desc}</div>
       </div>`).join('');
  }
  // Covenant values
  const dnCov   = Math.min(+(r.deuda_ebitda < 0 ? 2.0 : r.deuda_ebitda * 1.35 + 0.5).toFixed(2), 5.0);
  const dscrCov = Math.max(+(r.dscr * 0.82).toFixed(2), 1.10);
  const capexCov = +((r.ebitda * 0.25)).toFixed(1);

  const covCards = [
    { name:'DFN / EBITDA máximo', value: `≤ ${dnCov}x`, desc:'Límite de apalancamiento con headroom vs. ratio actual. Revisión semestral.' },
    { name:'DSCR mínimo', value: `≥ ${dscrCov}x`, desc:'Cobertura de deuda mínima con colchón del 18%. Cálculo sobre los últimos 12 meses.' },
    { name:'Capex máximo anual', value: `≤ ${capexCov} M€`, desc:'Cap equivalente al 25% del EBITDA. Excepciones previa aprobación del banco.' },
    { name:'Restricción dividendos', value: score >= 70 ? 'Max 40% NOPAT' : 'Suspensión total', desc: score >= 70 ? 'Distribución permitida si score > 70 y DFN/EBITDA < techo.' : 'Sin distribuciones mientras score < 70 o covenant en breach.' },
  ];

  document.getElementById('cov-grid').innerHTML = covCards.map(c => `
    <div class="cov-card">
      <div class="cov-name">${c.name}</div>
      <div class="cov-value">${c.value}</div>
      <div class="cov-desc">${c.desc}</div>
    </div>`).join('');

  // Pricing
  const tranches = [
    { label:'Tramo Senior A', spread: score >= 80 ? '175–275 bps' : score >= 70 ? '275–375 bps' : score >= 55 ? '375–500 bps' : 'N/A (no viable)', active: score >= 55 },
    { label:'Tramo Senior B', spread: score >= 70 ? '375–500 bps' : score >= 55 ? '500–650 bps' : 'N/A', active: score >= 55 },
    { label:'Tramo Subordinado', spread: score >= 70 ? '600–900 bps' : 'N/A (score insuficiente)', active: score >= 70 },
    { label:'Euribor base', spread: 'Euribor 3M/6M vigente', active: true },
  ];

  document.getElementById('pricing-grid').innerHTML = tranches.map(t => `
    <div class="pricing-card ${t.active ? 'active-price' : ''}">
      <div class="pc-tranche">${t.label}</div>
      <div class="pc-spread">${t.spread}</div>
      <div class="pc-note">${t.active ? 'Aplicable' : 'No aplicable'}</div>
    </div>`).join('');

  document.getElementById('pricing-note').textContent =
    `Pricing basado en score ${score}/100. Spreads orientativos sobre Euribor. Ajustar según rating interno final, colateral y estructura de la operación.`;

  // Extra conditions
  const extras = [];
  if (r.dscr < 1.5) extras.push('Amortización acelerada: al menos 15% anual del principal pendiente.');
  if (r.deuda_ebitda > 3.0) extras.push('Obligación de desinversión de activos no estratégicos si DFN/EBITDA > techo en 2 semestres consecutivos.');
  if (r.dias_cobro > 90) extras.push('Plan de mejora de capital circulante con revisión trimestral de factoring o confirming.');
  if (res.equipo.puntuacion < 50) extras.push('Nombramiento de CFO independiente o Chief Restructuring Officer como condición previa al desembolso.');
  if (extras.length === 0) extras.push('Sin condiciones adicionales fuera de los covenants estándar. Operación calificada en línea con política de riesgo.');
  extras.push('Reporting financiero trimestral con certificación de cumplimiento de covenants.');
  extras.push('Seguro de crédito sobre la cartera de clientes recomendado si concentración top-3 > 50%.');

  document.getElementById('cov-extra').innerHTML = extras.map(e =>
    `<div style="display:flex;gap:.7rem;align-items:flex-start;padding:.55rem 0;border-bottom:1px solid #1f1f2e;">
      <span style="color:#c9a84c;font-weight:800;flex-shrink:0;">→</span>
      <span style="font-size:.85rem;color:#f0f0f5;line-height:1.5;">${e}</span>
    </div>`).join('');
}

// ── DETALLE TAB ──
function renderDetalle(res, score, baseScore, histPenalty) {
  const fmtValMap = {
    dscr:          v => v.toFixed(2)+'x',
    deuda_ebitda:  v => v < 0 ? 'Caja neta' : v.toFixed(2)+'x',
    llcr:          v => v.toFixed(2)+'x',
    ebitda_margin: v => v.toFixed(1)+'%',
    ltv:           v => v === null ? 'N/A' : v.toFixed(1)+'%',
    ffo_dfn:       v => v.toFixed(1)+'%',
    dias_cobro:    v => Math.round(v)+' días',
    equipo:        v => v+' / 5',
    concentracion: v => v+' / 5',
    antiguedad:    v => v+' / 5',
    ciclicidad:    v => v+' / 5',
  };

  let rows = '';
  for (const [key, rv] of Object.entries(res)) {
    const valStr = fmtValMap[key] ? fmtValMap[key](rv.valor) : rv.valor;
    const badge  = rv.color === 'verde'   ? `<span class="badge-v">VERDE</span>` :
                   rv.color === 'amarillo' ? `<span class="badge-a">AMARILLO</span>` :
                   rv.color === 'naranja'  ? `<span class="badge-n">NARANJA</span>` :
                   `<span class="badge-r">ROJO</span>`;
    const gateBadge = rv.gating ? `<span class="badge-g">GATE</span> ` : '';
    rows += `<tr>
      <td>${gateBadge}${rv.nombre}</td>
      <td>${valStr}</td>
      <td><div style="display:flex;align-items:center;gap:.5rem;">
        <div style="flex:1;background:#f1f5f9;border-radius:10px;height:6px;">
          <div style="width:${rv.puntuacion}%;background:${rv.color==='verde'?'#22c55e':rv.color==='amarillo'?'#f59e0b':'#ef4444'};height:6px;border-radius:10px;"></div>
        </div>
        <span style="font-weight:700;font-size:.85rem;">${rv.puntuacion}</span>
      </div></td>
      <td>${rv.peso}%</td>
      <td style="font-weight:700;">${rv.contrib.toFixed(2)}</td>
      <td>${badge}</td>
    </tr>`;
  }
  document.getElementById('det-tbody').innerHTML = rows;

  const finalScore = Math.round(score);
  const finalColor = finalScore >= 70 ? '#22c55e' : finalScore >= 40 ? '#f59e0b' : '#ef4444';
  const rating = spRating(finalScore);
  let totalHtml = `<span style="font-size:1.1rem;color:${finalColor};">${finalScore} / 100</span> <span style="font-size:.85rem;color:${finalColor};font-weight:700;">(${rating.grade})</span>`;
  if (histPenalty && histPenalty.penalty !== 0) {
    totalHtml += `<div style="font-size:.75rem;color:#55556a;margin-top:.2rem;">Score cuantitativo: ${Math.round(baseScore||finalScore)} → ajuste historial: ${histPenalty.penalty>0?'+':''}${histPenalty.penalty} pts</div>`;
  }
  setText('det-total', totalHtml);
  const semC = finalScore >= 70 ? 'badge-v' : finalScore >= 40 ? 'badge-a' : 'badge-r';
  const semT = finalScore >= 70 ? 'VERDE'   : finalScore >= 40 ? 'AMARILLO' : 'ROJO';
  document.getElementById('det-semaforo').innerHTML = `<span class="${semC}">${semT}</span>`;
}

// ═══════════════════════════════════════════════════════════════
// EXAMPLES
// ═══════════════════════════════════════════════════════════════
const EXAMPLES = {
  tubacex: {
    ventas:767.5, ebitda:107, gastos_fin:14.5, imp_pagado:5, capex_mant:20,
    deuda_bruta:420, caja:165, activo_corriente:480, pasivo_corriente:378,
    clientes:76, proveedores:473, vida_media:4,
    inventario:85, aprovisionamientos:580,
    importe:0, plazo:5, tipo_int:6, colateral:0, tipo_col:'inmueble',
    equipo:'4', concentracion:'3', antiguedad:'5', ciclicidad:'2',
    sector_comp:'metalurgia',
    finalidad:'refinanciacion',
    rai:'ninguna', asnef:'no', impagos:'ninguno', demandas:'ninguna',
    relacion_bancaria:'buena', anios_sin_incidencias:10,
    colRows: [
      { tipo:'nave',          desc:'Naves industriales Amurrio/Llodio', bruto:180 },
      { tipo:'maquinaria',    desc:'Líneas de producción tubos sin costura', bruto:95 },
      { tipo:'cuentas_cobrar',desc:'Cartera clientes Oil & Gas', bruto:120 },
    ]
  },
  aa: {
    ventas:200, ebitda:46, gastos_fin:3, imp_pagado:5, capex_mant:3,
    deuda_bruta:40, caja:22, activo_corriente:90, pasivo_corriente:45,
    clientes:35, proveedores:30, vida_media:6,
    inventario:20, aprovisionamientos:140,
    importe:0, plazo:5, tipo_int:5, colateral:0, tipo_col:'inmueble',
    equipo:'5', concentracion:'4', antiguedad:'5', ciclicidad:'4',
    sector_comp:'quimica',
    finalidad:'maquinaria',
    rai:'ninguna', asnef:'no', impagos:'ninguno', demandas:'ninguna',
    relacion_bancaria:'buena', anios_sin_incidencias:8
  },
  c: {
    ventas:80, ebitda:5, gastos_fin:6, imp_pagado:0.5, capex_mant:1.5,
    deuda_bruta:65, caja:4, activo_corriente:35, pasivo_corriente:38,
    clientes:30, proveedores:20, vida_media:3,
    inventario:8, aprovisionamientos:68,
    importe:0, plazo:5, tipo_int:9, colateral:0, tipo_col:'maquinaria',
    equipo:'2', concentracion:'2', antiguedad:'2', ciclicidad:'2',
    sector_comp:'construccion',
    finalidad:'refinanciacion',
    rai:'activas', asnef:'si', impagos:'recurrente', demandas:'menor',
    relacion_bancaria:'deteriorada', anios_sin_incidencias:0
  }
};

function loadExample(name) {
  const ex = EXAMPLES[name];
  if (!ex) return;
  const numFields = ['ventas','ebitda','gastos_fin','imp_pagado','capex_mant',
    'deuda_bruta','caja','activo_corriente','pasivo_corriente','clientes',
    'proveedores','vida_media','inventario','aprovisionamientos',
    'importe','plazo','tipo_int','colateral','anios_sin_incidencias'];
  numFields.forEach(f => {
    const el = document.getElementById(f);
    if (el && ex[f] !== undefined) el.value = ex[f];
  });
  ['tipo_col','equipo','concentracion','antiguedad','ciclicidad','sector_comp',
   'finalidad','rai','asnef','impagos','demandas','relacion_bancaria'].forEach(f => {
    const el = document.getElementById(f);
    if (el && ex[f] !== undefined) el.value = ex[f];
  });
  _colRows = (ex.colRows || []).map(r => ({ tipo: r.tipo, desc: r.desc, bruto: r.bruto }));
  renderColTable();
  update();
}

function resetForm() {
  ['ventas','ebitda','gastos_fin','imp_pagado','capex_mant',
   'deuda_bruta','caja','activo_corriente','pasivo_corriente',
   'clientes','proveedores','inventario','aprovisionamientos'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('vida_media').value = 5;
  document.getElementById('importe').value = 0;
  document.getElementById('plazo').value = 5;
  document.getElementById('tipo_int').value = 6;
  document.getElementById('colateral').value = 0;
  document.getElementById('tipo_col').value = 'inmueble';
  document.getElementById('finalidad').value = 'maquinaria';
  document.getElementById('rai').value = 'ninguna';
  document.getElementById('asnef').value = 'no';
  document.getElementById('impagos').value = 'ninguno';
  document.getElementById('demandas').value = 'ninguna';
  document.getElementById('relacion_bancaria').value = 'buena';
  document.getElementById('anios_sin_incidencias').value = 0;
  document.getElementById('equipo').value = 3;
  document.getElementById('concentracion').value = 3;
  document.getElementById('antiguedad').value = 3;
  document.getElementById('ciclicidad').value = 3;
  document.getElementById('sector_comp').value = 'metalurgia';
  // Clear charts
  ['bar-chart','radar-chart','sect-chart','wc-cycle-chart'].forEach(id => {
    const el = document.getElementById(id);
    if (el) Plotly.purge(id);
  });
  updateBadge(0, false);
  document.getElementById('ratio-grid').innerHTML = '';
  document.getElementById('risk-grid').innerHTML = '';
  document.getElementById('gating-banner').classList.remove('visible');
  document.getElementById('nd-content').innerHTML = '<p style="color:#55556a;font-size:.85rem;">Introduzca datos para ver el análisis.</p>';
  document.getElementById('nd-capacity').innerHTML = '';
  document.getElementById('nd-ltv').innerHTML = '';
  document.getElementById('sect-tbody').innerHTML = '';
  document.getElementById('cov-grid').innerHTML = '';
  document.getElementById('pricing-grid').innerHTML = '';
  document.getElementById('cov-extra').innerHTML = '';
  document.getElementById('det-tbody').innerHTML = '';
  const wgrid = document.getElementById('wc-grid');
  if (wgrid) wgrid.innerHTML = '';
  const wsumm = document.getElementById('wc-summary');
  if (wsumm) wsumm.innerHTML = '';
  const chsec = document.getElementById('credit-hist-section');
  if (chsec) chsec.style.display = 'none';
  // Reset colateral inventory
  _colRows = [];
  renderColTable();
  ['col-s2','col-s3','col-s4'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  if (document.getElementById('col-waterfall')) Plotly.purge('col-waterfall');
}

// ═══════════════════════════════════════════════════════════════
// TABS
// ═══════════════════════════════════════════════════════════════
const TAB_IDS = ['scoring','wc','nueva_deuda','comparables','covenants','colateral','detalle'];

function switchTab(name) {
  TAB_IDS.forEach(t => {
    document.getElementById('tab-'+t).classList.toggle('active', t === name);
  });
  document.querySelectorAll('.tab').forEach((el, i) => {
    el.className = 'tab ' + (TAB_IDS[i] === name ? 'active' : 'inactive');
  });
}

// ═══════════════════════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════════════════════
function setText(id, html) {
  const el = document.getElementById(id);
  if (el) el.innerHTML = html;
}

// ═══════════════════════════════════════════════════════════════
// COLATERAL ANALYSIS
// ═══════════════════════════════════════════════════════════════

const COL_CFG = {
  inmueble:       { label:'Inmueble comercial', haircut:0.40, execMid:3.0,    execLabel:'24–48 meses' },
  nave:           { label:'Nave industrial',    haircut:0.40, execMid:3.0,    execLabel:'24–48 meses' },
  maquinaria:     { label:'Maquinaria',         haircut:0.60, execMid:0.75,   execLabel:'6–12 meses'  },
  stock:          { label:'Stock / Inventario', haircut:0.50, execMid:0.167,  execLabel:'1–3 meses'   },
  cuentas_cobrar: { label:'Cuentas a cobrar',   haircut:0.30, execMid:0.375,  execLabel:'3–6 meses'   },
  otros:          { label:'Otros',              haircut:0.50, execMid:0.75,   execLabel:'6–12 meses'  },
};

let _colRows = [];

function addColRow() {
  _colRows.push({ tipo:'inmueble', desc:'', bruto:0 });
  renderColTable();
  update();
}

function removeColRow(i) {
  _colRows.splice(i, 1);
  renderColTable();
  update();
}

function onColChange(i, field, val) {
  _colRows[i][field] = field === 'bruto' ? (parseFloat(val) || 0) : val;
  if (field !== 'desc') { renderColTable(); update(); }
}

function renderColTable() {
  const tbody = document.getElementById('col-tbody');
  const tfoot = document.getElementById('col-tfoot');
  if (!tbody) return;

  if (_colRows.length === 0) {
    tbody.innerHTML = '<tr id="col-empty"><td colspan="7" style="text-align:center;color:#55556a;padding:1.8rem;font-size:.85rem;">Sin activos. Pulsa "+ Añadir activo" para comenzar.</td></tr>';
    tfoot.style.display = 'none';
    return;
  }
  tfoot.style.display = '';

  let totalBruto = 0, totalNeto = 0;
  const opts = key => Object.entries(COL_CFG).map(([k,v]) =>
    `<option value="${k}" ${k===key?'selected':''}>${v.label}</option>`).join('');

  tbody.innerHTML = _colRows.map((row, i) => {
    const cfg  = COL_CFG[row.tipo] || COL_CFG.otros;
    const neto = (row.bruto||0) * (1 - cfg.haircut);
    totalBruto += row.bruto||0;
    totalNeto  += neto;
    return `<tr>
      <td><select onchange="onColChange(${i},'tipo',this.value)" class="col-inp col-sel">${opts(row.tipo)}</select></td>
      <td><input type="text" value="${row.desc||''}" onchange="onColChange(${i},'desc',this.value)" placeholder="Descripción..." class="col-inp col-inp-desc"></td>
      <td style="text-align:right;"><input type="number" value="${row.bruto||''}" step="0.1" min="0" oninput="onColChange(${i},'bruto',this.value)" class="col-inp col-inp-num"></td>
      <td class="col-haircut">${Math.round(cfg.haircut*100)}%</td>
      <td class="col-neto">${neto.toFixed(2)}</td>
      <td style="font-size:.75rem;color:#55556a;white-space:nowrap;">${cfg.execLabel}</td>
      <td style="text-align:center;"><button class="col-del-btn" onclick="removeColRow(${i})">×</button></td>
    </tr>`;
  }).join('');

  document.getElementById('col-t-bruto').textContent = totalBruto.toFixed(2);
  document.getElementById('col-t-neto').textContent  = totalNeto.toFixed(2);
}

function recalcColateral() {
  const s2 = document.getElementById('col-s2');
  const s3 = document.getElementById('col-s3');
  const s4 = document.getElementById('col-s4');
  if (!s2) return;

  if (_colRows.length === 0 || !_currentData) {
    s2.style.display = s3.style.display = s4.style.display = 'none';
    return;
  }

  const { d, score } = _currentData;

  // Compute per-row enriched values
  const rows = _colRows.map(row => {
    const cfg  = COL_CFG[row.tipo] || COL_CFG.otros;
    const neto = (row.bruto||0) * (1 - cfg.haircut);
    const pv   = neto / Math.pow(1.08, cfg.execMid);
    return { ...row, ...cfg, neto, pv };
  });

  const totalBruto = rows.reduce((s,r) => s + (r.bruto||0), 0);
  const totalNeto  = rows.reduce((s,r) => s + r.neto, 0);
  const totalPV    = rows.reduce((s,r) => s + r.pv, 0);

  const importe = d.importe > 0 ? d.importe : Math.max(_currentData.r.dfn, 0.001);
  const ltv       = totalBruto > 0 ? (importe / totalBruto * 100) : null;
  const recRate   = importe > 0 ? Math.min(totalPV / importe * 100, 200) : 0;
  const lgd       = Math.max(1 - recRate/100, 0);
  const ead       = importe;
  const pd        = score > 70 ? 0.015 : score >= 50 ? 0.035 : 0.07;
  const rwa       = ead * pd * lgd * 1.2 * 12.5;
  const expLoss   = ead * pd * lgd;

  s2.style.display = s3.style.display = s4.style.display = '';

  // ── KPI cards ──
  const kpiCfg = [
    { label:'LTV',              val: ltv !== null ? ltv.toFixed(1)+'%' : 'N/A',
      sub:'Deuda / Colateral bruto',
      cls: ltv === null ? 'rb' : ltv < 50 ? 'rv' : ltv < 60 ? 'ra' : ltv < 70 ? 'rn' : 'rr' },
    { label:'Recovery Rate',    val: recRate.toFixed(1)+'%',
      sub:'Valor neto PV / Deuda',
      cls: recRate >= 70 ? 'rv' : recRate >= 40 ? 'ra' : 'rr' },
    { label:'LGD',              val: (lgd*100).toFixed(1)+'%',
      sub:'Loss Given Default',
      cls: lgd < 0.30 ? 'rv' : lgd < 0.60 ? 'ra' : 'rr' },
    { label:'EAD',              val: ead.toFixed(2)+' M€',
      sub:'Exposure at Default', cls:'rb' },
    { label:'PD estimada',      val: (pd*100).toFixed(2)+'%',
      sub:'Basada en score '+score,
      cls: pd <= 0.015 ? 'rv' : pd <= 0.035 ? 'ra' : 'rr' },
    { label:'Pérdida esperada', val: expLoss.toFixed(3)+' M€',
      sub:'EAD × PD × LGD',
      cls: expLoss/ead < 0.01 ? 'rv' : expLoss/ead < 0.05 ? 'ra' : 'rr' },
    { label:'RWA estimado',     val: rwa.toFixed(2)+' M€',
      sub:'EAD × PD × LGD × 15', cls:'rb' },
    { label:'Recovery PV total',val: totalPV.toFixed(2)+' M€',
      sub:'Descontado al 8%',
      cls: totalPV >= ead ? 'rv' : totalPV >= ead*0.6 ? 'ra' : 'rr' },
    { label:'Colateral bruto',  val: totalBruto.toFixed(2)+' M€',
      sub:'Total inventario', cls:'rb' },
    { label:'Colateral neto',   val: totalNeto.toFixed(2)+' M€',
      sub:'Tras haircuts', cls:'rb' },
  ];
  document.getElementById('col-kpis').innerHTML = kpiCfg.map(k =>
    `<div class="rec-kpi ${k.cls}">
       <div class="rk-label">${k.label}</div>
       <div class="rk-value">${k.val}</div>
       <div class="rk-sub">${k.sub}</div>
     </div>`).join('');

  // ── Waterfall chart ──
  const perdida = Math.max(importe - totalPV, 0);
  Plotly.react('col-waterfall', [
    { type:'bar', name:'Deuda prestada',       x:['Deuda prestada'],       y:[importe],
      marker:{color:'#c9a84c'}, text:[importe.toFixed(2)+' M€'], textposition:'outside', textfont:{size:11,color:'#f0f0f5',family:'Inter,sans-serif'} },
    { type:'bar', name:'Recovery esperado (PV)',x:['Recovery esperado (PV)'],y:[totalPV],
      marker:{color:'#4caf7d'}, text:[totalPV.toFixed(2)+' M€ ('+recRate.toFixed(0)+'%)'], textposition:'outside', textfont:{size:11,color:'#f0f0f5',family:'Inter,sans-serif'} },
    { type:'bar', name:'Pérdida esperada (EL)', x:['Pérdida esperada (EL)'],y:[expLoss],
      marker:{color:'#e05252'}, text:[expLoss.toFixed(3)+' M€'], textposition:'outside', textfont:{size:11,color:'#f0f0f5',family:'Inter,sans-serif'} },
  ], {
    barmode:'group', paper_bgcolor:'#111118', plot_bgcolor:'#111118',
    legend:{
      orientation:'h', y:1.22,
      font:{size:11, color:'#f0f0f5', family:'Inter,sans-serif'},
      bgcolor:'rgba(0,0,0,0)', borderwidth:0
    },
    xaxis:{ showgrid:false, showline:false, tickfont:{size:11, color:'#f0f0f5', family:'Inter,sans-serif'} },
    yaxis:{
      title:{ text:'M€', font:{size:10, color:'#55556a'} },
      showgrid:false, zeroline:false, showline:false,
      tickfont:{size:10, color:'#55556a', family:'Inter,sans-serif'}
    },
    margin:{ t:55,b:10,l:60,r:20 }, height:300,
    font:{ family:'Inter,sans-serif', color:'#f0f0f5' }
  }, { displayModeBar:false, responsive:true });

  // ── Priority table ──
  const sorted = [...rows].sort((a,b) => a.execMid - b.execMid);
  let cumPV = 0;
  document.getElementById('col-priority').innerHTML = sorted.map((row, i) => {
    cumPV += row.pv;
    const cumPct  = importe > 0 ? (cumPV / importe * 100) : 0;
    const covered = cumPV >= importe;
    const justCov = covered && (cumPV - row.pv) < importe;
    const rowCls  = justCov ? 'pri-covered' : covered ? 'pri-covered' : '';
    const badge   = covered
      ? '<span style="background:rgba(76,175,125,.15);color:#4caf7d;padding:.15rem .5rem;border-radius:20px;font-size:.72rem;font-weight:700;">✓ Cubierto</span>'
      : `<span style="background:rgba(224,82,82,.15);color:#e05252;padding:.15rem .5rem;border-radius:20px;font-size:.72rem;font-weight:700;">✗ Déficit ${(importe-cumPV).toFixed(2)}M€</span>`;
    return `<tr class="${rowCls}">
      <td style="font-weight:800;color:#c9a84c;">${i+1}</td>
      <td>${row.label}</td>
      <td style="color:#55556a;">${row.desc||'—'}</td>
      <td><span style="background:#18181f;border-radius:4px;padding:.15rem .4rem;font-size:.75rem;">${row.execLabel}</span></td>
      <td style="text-align:right;font-weight:700;">${row.pv.toFixed(2)} M€</td>
      <td style="text-align:right;">
        <span style="font-weight:800;color:${cumPct>=100?'#4caf7d':cumPct>=60?'#c9a84c':'#e05252'};">${Math.min(cumPct,100).toFixed(1)}%</span>
      </td>
      <td>${badge}</td>
    </tr>`;
  }).join('');
}

// ═══════════════════════════════════════════════════════════════
// PDF EXPORT
// ═══════════════════════════════════════════════════════════════
function exportPDF() {
  // Update cover date and report number
  const now = new Date();
  const dateStr = now.toLocaleDateString('es-ES', { day:'2-digit', month:'long', year:'numeric' });
  const el = document.getElementById('cover-date');
  if (el) el.textContent = dateStr;
  const crn = document.getElementById('cover-report-num');
  if (crn) crn.textContent = document.getElementById('report-number')?.textContent || 'TO-—';
  // Update cover sub with empresa name
  const emp = document.getElementById('empresa-nombre')?.value;
  const csub = document.getElementById('cover-empresa-sub');
  if (csub && emp) csub.textContent = emp + ' — Análisis de Riesgo Crediticio';
  // Update summary empresa paragraph
  const sumEmp = document.getElementById('pdf-summary-empresa');
  if (sumEmp && emp) {
    const scoreEl = document.getElementById('badge-score');
    const sc = scoreEl ? scoreEl.textContent : '—';
    sumEmp.textContent = 'El presente informe analiza la operación de crédito de ' + emp +
      ', con una puntuación de riesgo de ' + sc + '/100. Se evalúa la capacidad de servicio de la ' +
      'deuda, el perfil de apalancamiento y los factores cualitativos del equipo directivo, ' +
      'base de clientes y estabilidad sectorial.';
  }

  // Show cover + summary + all sections + legal + print headers
  const cover   = document.getElementById('pdf-cover');
  const summary = document.getElementById('pdf-summary');
  const legal   = document.getElementById('pdf-legal');
  const sections = document.querySelectorAll('.section');
  const tabs     = document.querySelectorAll('.tab');
  const pHeaders = document.querySelectorAll('.print-header');

  const showPage = (el) => {
    if (!el) return;
    el.style.display  = 'flex';
    el.style.position = 'relative';
    el.style.width    = '100%';
    el.style.height   = '100vh';
  };

  // ── Force CSS variables to white/light values BEFORE printing ──
  // This overrides :root values via inline style on html element (highest specificity)
  const root = document.documentElement;
  root.style.setProperty('--bg',         '#ffffff');
  root.style.setProperty('--surface',    '#ffffff');
  root.style.setProperty('--surface2',   '#f5f5f5');
  root.style.setProperty('--border',     '#e0e0e0');
  root.style.setProperty('--text',       '#111111');
  root.style.setProperty('--text-muted', '#888888');
  // Fix hardcoded white text in ph-logo elements (not a variable)
  document.querySelectorAll('.pdf-page-header .ph-logo').forEach(el => {
    el.style.color = '#111111';
    el.querySelectorAll('span').forEach(s => s.style.color = '#c9a84c');
  });
  document.querySelectorAll('.pdf-page-header .ph-sub').forEach(el => el.style.color = '#999');

  showPage(cover);
  showPage(summary);
  showPage(legal);
  sections.forEach(s => s.style.display = 'block');
  tabs.forEach(t => t.style.display = 'none');
  pHeaders.forEach(h => h.style.display = 'flex');

  // ── Relayout charts to white before printing ──
  const CHART_IDS = ['bar-chart','radar-chart','wc-cycle-chart','sect-chart','col-waterfall'];
  const WHITE_LAY = {
    paper_bgcolor: '#ffffff', plot_bgcolor: '#f9f9f9',
    autosize: false, width: 680, height: 260,
    font: { color: '#333333', family: 'Inter,sans-serif' },
    'xaxis.tickfont.color': '#555', 'xaxis.title.font.color': '#888',
    'xaxis.zerolinecolor': '#e0e0e0',
    'yaxis.tickfont.color': '#555', 'yaxis.title.font.color': '#888',
    'yaxis.zerolinecolor': '#e0e0e0',
    'legend.font.color': '#333'
  };
  const RADAR_WHITE = {
    paper_bgcolor: '#ffffff',
    autosize: false, width: 680, height: 280,
    font: { color: '#333333', family: 'Inter,sans-serif' },
    'polar.bgcolor': '#ffffff',
    'polar.radialaxis.tickfont.color': '#aaa',
    'polar.radialaxis.gridcolor': 'rgba(0,0,0,0.07)',
    'polar.angularaxis.tickfont.color': '#333'
  };
  CHART_IDS.forEach(id => {
    const el = document.getElementById(id);
    if (!el || !el.data) return;
    try {
      Plotly.relayout(el, id === 'radar-chart' ? RADAR_WHITE : WHITE_LAY);
    } catch(e) {}
  });

  // Show frame bars during print
  const frame = document.getElementById('print-frame');
  if (frame) frame.style.display = 'block';

  // Delay so charts re-render before print dialog opens
  setTimeout(() => {
    window.print();

    // Restore everything after print dialog closes
    setTimeout(() => {
      if (frame) frame.style.display = 'none';
      [cover, summary, legal].forEach(p => {
        if (!p) return;
        p.style.display = 'none'; p.style.position = '';
        p.style.width = ''; p.style.height = '';
      });
      sections.forEach(s => s.style.display = '');
      tabs.forEach(t => t.style.display = '');
      pHeaders.forEach(h => h.style.display = 'none');
      document.querySelectorAll('.section.active').forEach(s => s.style.display = 'block');
      // ── Restore CSS variables and overridden text colors ──
      const root = document.documentElement;
      ['--bg','--surface','--surface2','--border','--text','--text-muted'].forEach(v =>
        root.style.removeProperty(v)
      );
      document.querySelectorAll('.pdf-page-header .ph-logo').forEach(el => {
        el.style.color = '';
        el.querySelectorAll('span').forEach(s => s.style.color = '');
      });
      document.querySelectorAll('.pdf-page-header .ph-sub').forEach(el => el.style.color = '');
      // Restore dark chart theme
      const DARK_LAY = {
        paper_bgcolor: '#111118', plot_bgcolor: '#111118',
        autosize: true, width: null, height: null,
        font: { color: '#f0f0f5', family: 'Inter,sans-serif' },
        'xaxis.tickfont.color': '#f0f0f5', 'xaxis.title.font.color': '#55556a',
        'xaxis.zerolinecolor': '#1f1f2e',
        'yaxis.tickfont.color': '#55556a', 'yaxis.title.font.color': '#55556a',
        'yaxis.zerolinecolor': '#1f1f2e',
        'legend.font.color': '#f0f0f5'
      };
      const RADAR_DARK = {
        paper_bgcolor: '#111118', autosize: true, width: null, height: null,
        font: { color: '#f0f0f5', family: 'Inter,sans-serif' },
        'polar.bgcolor': '#111118',
        'polar.radialaxis.tickfont.color': '#55556a',
        'polar.radialaxis.gridcolor': 'rgba(31,31,46,0.6)',
        'polar.angularaxis.tickfont.color': '#c9a84c'
      };
      CHART_IDS.forEach(id => {
        const el = document.getElementById(id);
        if (!el || !el.data) return;
        try { Plotly.relayout(el, id === 'radar-chart' ? RADAR_DARK : DARK_LAY); } catch(e) {}
      });
    }, 1600);
  }, 450);
}

// ── Init ──
window.addEventListener('load', () => {
  // Report header
  const now = new Date();
  const rn = document.getElementById('report-number');
  if (rn) rn.textContent = 'TO-' + now.getFullYear() + '-' + (Math.floor(1000 + Math.random() * 9000));
  const rd = document.getElementById('report-date');
  if (rd) rd.textContent = now.toLocaleDateString('es-ES', { day:'2-digit', month:'short', year:'numeric' });
  // Load Tubacex as default example
  loadExample('tubacex');
});
</script>
<!-- ── Print frame (hidden on screen, visible in print) ── -->
<div id="print-frame" style="display:none;">
  <div class="pf-top"></div>
  <div class="pf-bottom">
    <span>TokenOriginate · Credit Risk Platform · Uso interno y análisis orientativo</span>
    <span>© TokenOriginate 2026 · info@tokenoriginate.com</span>
  </div>
</div>

</body>
</html>
